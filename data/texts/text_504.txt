Meghna Singh · Saksham Goel · Abhiraj Mohan · Louis Kazaglis · Jaideep Srivastava Abstract The quality of sleep has a deep impact on people’s physical and mental health. People with insuﬃcient sleep are more likely to report physical and mental distress, activity limitation, anxiety, and pain. Moreover, in the past few years, there has been an explosion of applications and devices for activity monitoring and health tracking. Signals collected from these wearable devices can be used to study and improve sleep quality. In this paper, we utilize the relationship between physical activity and sleep quality to ﬁnd ways of assisting people improve their sleep using machine learning techniques. People usually have several behavior modes that their bio-functions can be divided into. Performing time series clustering on activity data, we ﬁnd cluster centers that would correlate to the most evident behavior modes for a speciﬁc subject. Activity recipes are then generated for good sleep quality for each behavior mode within each cluster. These activity recipes are supplied to an activity recommendation engine for suggesting a mix of relaxed to intense activities to subjects during their daily routines. The recommendations are further personalized based on the subjects’ lifestyle constraints, i.e. their age, gender, body mass index (BMI), resting heart rate, etc., with the objective of the recommendation being the improvement of that night’s quality of sleep. This would in turn serve a longer-term health objective, like lowering heart rate, improving the overall quality of sleep, etc. Keywords sleep quality · activity recipe · good sleep · actigraphy · personalized recommendation · behavior modes People spend a third of their lives sleeping because it is one of the most vital activities for maintaining good health. The quality of sleep has a deep impact on people’s physical and mental health. Poor sleep quality has been linked to various chronic health conditions like obesity and diabetes (Taheri, 2006; Knutson et al, 2006; Palotti et al, 2019) as well as cardiovascular diseases (Kasasbeh et al, 2006) and depression (Murphy and Peterson, 2015). Two recent studies (Blume et al, 2020; Wright Jr et al, 2020) have shown how movement restrictions imposed due to COVID-19 led to an increase in sleep duration, but lowering of the quality of sleep because of increase in perceived burden. to measure sleep quality. PSG measures brain activity, eye movements, muscle activity, and heart rhythm. But it is a highly intrusive and costly approach. Due to its complexity, it is typically only performed for one or two nights. An alternative to assess the quality of sleep is the use of wearables, such as actigraphy devices. Actigraphy devices are wristwatch-like devices that allow continuous activity recording for several weeks. Several studies have tested the eﬃcacy of wrist-worn actigraphy devices for activity and sleep monitoring (Weiss et al, 2010; Diaz et al, 2015) and even compared the data with PSG, with satisfying results (Cole et al, 1992; Jean-Louis et al, 2001; Quante et al, 2018; Smith et al, 2018). out during the day could aﬀect sleep. (Kredlow et al, 2015) show the impact of diﬀerent exercise levels on diﬀerent stages of sleep, sleep time and sleep eﬃciency. (Chennaoui et al, 2015) discuss how sleep and exercise inﬂuence each other: how diﬀerent physical activity levels inﬂuence physical stages during sleep, and how sleep quality inﬂuences exercise performance. Other studies demonstrated that a certain amount of exercise helps to reduce insomnia (Yang et al, 2012; Merrill et al, 2007) and sleep apnea (Awad et al, 2012). 2016), which focuses on collecting and analyzing data about oneself, more people have become aware of their health, which in turn has led to a plethora of wearable devices and ﬁtness tracking applications for consumers to improve their health and well-being. The products available are getting more sophisticated and can track a wide array of things, like heart rate, sleep patterns, steps taken, and provide analysis and feedback on how these can be improved to lead a healthier life. These self-tracking devices have empowered people to monitor their health proactively and be able to take appropriate measures to alleviate possible health risks. tracking motivated us to study the relationship between physical activity and sleep quality using machine learning techniques, and to ﬁnd ways of assisting people in improving their sleep. Moreover, most of the existing ﬁtness tracking applications provide generic recommendations to consumers for helping them Polysomnography (PSG) is the state-of-the-art and most accurate method There have been various studies that have shown how activities carried With the advent of the Quantiﬁed-Self movement (Swan, 2009; Lupton, This immense body of work in the domain of wearable devices and sleep achieve their health goals, usually based on gender and age. The “one-size-ﬁtsall” principle doesn’t necessarily fulﬁll the health objectives of many people (Evenson et al, 2015). ieving required behavioral change, as the state of health, level of self-control, physical activity types, duration of those activities, and timing would be different for each subject. Recommendations should be such that they are based on users’ health goals, but at the same time are easy to adopt. If the goal is to lose weight, but the user has very high BMI, then recommending 10,000 steps a day may not be an achievable recommendation and may even lead to the user abandoning the recommendation system completely. Instead, recommending 5,000 steps a day, and gradually increasing the goal based on adoption would be the right approach. example of a personalized recommendation that is based on the user’s goal (to reach a destination B). If the application gives wrong directions (maybe a road was closed), then the consequence would at worst be that the user gets late in reaching their destination. But in the health domain, the consequences of incorrect recommendations are far more signiﬁcant and can be immediate or even long-term. For example, if person A has a resting heart rate of 90 and person B has a resting heart rate of 65. Recommending a running activity to A would increase their risk of stroke, whereas the same recommendation would be good for person B. Therefore recommendations should be adapting and evolving, keeping in mind the health of the user. tems for recommending workout routes based on user preferences and health proﬁles. (Alcaraz-Herrera and Palomares, 2019) recommend food and exercise bundles to users based on their preferences and health goals. (Nosakhare and Picard, 2020) used self-reported health data from users to build machine learning models for predicting stress levels of users each day as well as ﬁnding days similar to the current day but with lower stress levels so that recommendations can be made about changes in behaviors that would result in lowering stress. Recommender system for Improving Sleep quality, that uses individual health and lifestyle constraints for making activity recommendations. We are addressing the goal of improving sleep quality, but this approach can be expanded to achieve other personal health goals like lowering heart rate and increasing daily step count. The key contributions of this paper are: 1. Providing personalized activity recommendations to users at various points 2. An approach to generating activity recipes that would lead to a speciﬁc 3. Using health metadata, or lifestyle constraints, to select which recommen- Personalization is critical for providing eﬀective recommendations, i.e. ach- Google Maps providing directions to a user to go from place A to B is an (Ni et al, 2019; Loepp and Ziegler, 2018) present such personalized sys- In this paper, we present PARIS: a goal-directed Personalized Activity in time, using their current activity and calculating activity deﬁcits to achieve a daily goal. daily goal. dations would be most appropriate for a given user. For a target user u recommendations at diﬀerent moments of the day t and wellness factors as well as their daily activity patterns, what we term as behavior modes BM, calibrated against their activity until the time of recommendation t each user u such that where x days for which data is available for user u. based on their values, such that for x which contains totals for each activity level label at day i. The activity level label can take one of the values in the activity levels enumeration, where activity levels = {Light, M oderate, Sedentary, V igorous} is not used for activity recommendation. Based on this, let S the aggregated minute count for each activity level label in the activity levels enumeration for user u from time t Using the actigraphy time series dataset X behavior modes for the day, i.e. activity patterns that represent a particular day for the user. We introduce further notation to account for the computed behavior mode as follows: which belong to the same behavior mode b. This is deﬁned as where BM u. We will use a similar notation for aggregated activity level minute count represented as S Using the aggregated activity level label summaries for the whole day S each behavior mode BM to healthy sleep for the user. Activity recipes is a matrix represented as Let Xbe a matrix of minute level actigraphy data for the entire day for is the actigraphy data for user u at day i, and N is the number of The raw actigraphy counts are also categorized into activity level labels Sedentary activity level is discarded from this enumeration as this category Xis the modiﬁed matrix Xwhich contains only actigraphy data for days It represents L diﬀerent activity recipes learned for each behavior mode for each user and comprises the total aggregated minutes for each activity level label in activity levels enumeration. Let M age, gender, BMI, etc., that help proﬁle the user’s health and wellness aspects. we provide a recommendation. At t represented as x ﬁnd the behavior mode b that is closest to target user u activity recipe a The main tasks performed as part of our research and listed below, and the process ﬂow is shown in Fig. 1. 1. Generating behavior modes using clustering algorithms for each subject 2. Developing predictive models to extract various activity recipes (Sathya- 3. Using these models to recommend at any point in time, the activities the For all subjects, we performed clustering over the minute-level activity count time series. Each cluster represents the subject’s routine based on activity performed throughout the days for the same subject and we label these clusters as the subject’s behavior modes. The cluster centroids explain the aggregate characteristics of activity time series in their respective clusters thus describing the behavior mode. ing, although we did use many diﬀerent distance metrics to compute similarity/distance between time series for our clustering: 1. L1 norm(X,Y) = 2. L2 norm(X,Y) = be a vector ∈ Rcontaining information m on diﬀerent statistics like Let trepresent the minute count since the onset of day (12:00 AM) when The recommendation problem our research is attempting to solve is to (i) while taking into account lifestyle constraints M. based on their activity (using movement intensity) (Section 3.1) narayana, 2017) for each behavior mode, which result in Good Sleep (Section 3.2. subject should carry out for the rest of the day, to ensure a good night’s sleep (Section 3.3) Clustering performed for detecting behavior modes used K-Means cluster- 3. Dynamic Time Warping (DTW) 4. Correlation(X,Y) = 5. Kullback-Leibler (KL) Divergence(X,Y) = 6. Jensen-Shannon (JS) Divergence(X,Y) = of distance in higher dimensions, especially time series, becomes more abstract and it is important to have a stable yet powerful. While L1 Norm and L2 Norm are on the simple side of the spectrum, metrics like DTW and KL divergence are much more powerful in extracting information based on overall time series distribution. KL and JS are very similar distance metrics. JS can be considered a more symmetric version of KL since it is not symmetric. We computed KL divergence X→Y and Y→X and took the mean of the two. JS divergence takes the mean of X and Y and takes the mean of KL divergence between X and its mean and Y and its mean. ing results for each clustering model from our grid search. We optimized for the maximum silhouette score to ﬁnd the best clustering model. We used silhouette score because it helps maximize intra-cluster similarity and minimize M =(X + Y ) We considered a variety of diﬀerent distance metrics because the concept We used silhouette score as the primary evaluation criteria for our clusterinter-cluster similarity, thus helping group similar activity pattern while separating dissimilar patterns. The silhouette score for a single point is described as follows every other data point in the same cluster. And b(i) is deﬁned as the mean distance between data point i and all data points from its closest neighbor cluster. similar clustering over principal frequencies identiﬁed for each time series using FFT to reduce the noise associated. Clustering over the frequency domain makes sure that we group behavior mode based on core characteristics. From the behavior modes that we obtain, we can ﬁnd the weekday distribution to better understand the weekly routine and the weekly behavior mode pattern. After computing the behavior modes for each subject, activity recipes were learned for Good Sleep per behavior mode per cluster. Clustering was applied again over aggregated activity level summaries for each day within the same behavior mode. Activity level summaries were calculated as the duration (number of minutes) of a speciﬁc activity level label (Light, Moderate and Vigorous) from the time the subject wakes up to the current time. For this step, we removed the sedentary activity level because our recommendation engine would recommend being physically active, which only depends on light, moderate and vigorous activity levels. For each record within the same cluster, we computed the sleep eﬃciency which is deﬁned as the ratio of total time asleep to total time in bed. Sleep Ef ficiency = based on the sleep eﬃciency such that Good Sleep is deﬁned as sleep eﬃciency greater than 0.90. This process was repeated for each cluster identiﬁed for each behavior mode for each subject. Each resulting cluster was identiﬁed as a Good Sleep cluster if the ratio of the number of records with Good Sleep within the cluster to the number of records with Poor Sleep within the cluster is greater than or equal to 2. After identifying all the Good Sleep clusters, activity recipes were calculated as the cluster centers for those sub-clusters. Means clustering using L2-Norm distance metric, such that we optimized the silhouette score to ﬁnd the number of sub-clusters. The data for this step Here, a(i) is deﬁned as the mean distance between the data point i and Apart from clustering over minute level time series data we also perform Then each record was tagged as either Good Sleep day or Poor Sleep day For detecting behavior modes the clustering algorithm selected was Kconsisted of independent features in a 3-dimensional space (activity levels excluding sedentary activity) which is a perfect candidate for K-Means clustering because of the low number of dimensions and feature independence. Since the features are in an N-Dimensional space and do not represent any kind of timeseries or distribution, we selected L-2 norm as the distance metric. The activity recommendation process assigns a behavior mode based on the target user u behavior mode, x behavior modes, and the cluster center with the shortest distance is selected as the behavior mode b. Comparison is done on cropped data to resemble the amount of data collected so far, i.e. for time duration (0, t then aggregated by activity levels to get S to the cluster centers of the activity sub-clusters, which returns the probability of S corresponding to the cluster centers are ordered by this probability, and are used to calculate activity deﬁcit for the remainder of the day. to achieve the same activity counts as being in the activity recipes.The model also takes into consideration the user’s metadata M recipes if required, to ensure that a recommendation is such that it does not have adverse eﬀects on the user’s health, along with being one that could be easily adopted. Dataset collected for the Hispanic Community Health Study / Study of Latinos (HCHS/SOL), and made available by NSRR, has been used in this project (Zhang et al, 2018; Redline et al, 2014). The dataset contains data for Latino adults aged 18–74 years at enrollment, which includes one night of in-home PSG data for 12,088 participants, along with aggregated survey questionnaire data about health, lifestyle, and sleep. Additionally, the Sue˜no Ancillary study recruited 2,252 HCHS/SOL participants to wear wrist-worn actigraphy devices (Actiwatch Spectrum, Philips Respironics) for a week. Actigraphy data for 1,887 participants has been made available for use. The study was approved by the Institutional Review Boards at all HCHS/SOL institutions and written informed consent was obtained from all participants. with heart rate and actigraphy time-series data to be able to detect behavior Next, xis converted to the activity level vector l, which is The model then recommends diﬀerent activity regimes based on the deﬁcit Our research focuses on utilizing the metadata about each subject along modes and extract sleep recipes. The heart rate data for subjects are from the one-night PSG data. The actigraphy data includes about 7 days of activity data (activity count) at 30-second intervals along with annotations for sleep and wake periods for 1,887 subjects. The intersection between these two cohorts was a dataset of 1,782 subjects. Metadata for each subject includes many biological, biographical, and physical features like age, gender, BMI, diabetes, ECG abnormalities, medical history, etc. with data curators, such that each row has an interval type, which can be ACTIVE, REST, REST-S or EXCLUDED. A subject is considered asleep between the REST intervals where the REST records are before sleep onset and after sleep oﬀset while REST-S is the actual sleep period. There is also an awake indicator ﬁeld, which is 1 when the subject is awake. Activity data of 1,782 subjects were split into 24-hour periods and then data points aligned by their time. The data is aggregated to minute-level counts using a rolling sum with a window of size 2. Any subject with less than 7 days of activity was dropped. The resulting dataset consisted of 1,769 subjects with 7 activity time series each, where each time series corresponded to one day of the week. This data will be used to generate behavior modes (section 3.1) activity level thresholds or cut-points (Colley et al, 2011; Wong et al, 2011), where the labels correspond to movement intensity levels: sedentary, light, moderate or vigorous. Only the rows which had been labeled ACTIVE were selected for this step. The counts were aggregated per subject per day per activity label to generate activity level summaries. A sample resulting data is shown in table 1. This data will be used for generating activity recipes (section 3.2) REST and REST-S were used. The awake indicator was used to check if there The actigraphy data has been annotated by the Actiwatch software along The minute-level counts were next used to generate activity labels based on For calculating sleep duration and sleep eﬃciency, only the rows labeled are Wake After Sleep Onset (WASO) periods if the awake indicator was 1 for at least 5 minutes (i.e., ten consecutive rows of data). The total minutes of WASO and REST are considered as M inutesAwakeInBed during the sleep period. (FFT) to get the principal frequencies and migrate the data from time to frequency domain. We used FFT to reduce the time series into a sum of sinusoidal components. Doing so allowed us to reduce the noise associated with a time series. We took the ﬁrst 25 components to further eliminate noise and outlier values from the time series. For user behavior modes, the number of clusters with the highest silhouette score was found to be two. We ran twenty scenarios to compare silhouette scores and the highest we achieved was with cluster centers being equal to two. The purity of all such clusters was tested to ﬁnd the composition based on the days of the week. Fig. 3 shows the activity cluster composition using two distance metrics: Euclidean and Jensen-Shannon (JS) divergence. Clustering over activity using Jensen-Shannon led to a marginally higher cluster purity compared to clustering done with Euclidean. Cluster 1 in Jensen-Shannon clustering has a higher number of weekend days compared to cluster 1 in euclidean clustering. We used Jensen-Shannon over Kullback-Leibler because Jensen-Shannon is a symmetrical incarnation of the same formula. Figure 2 describes the cluster centers for the two behavior mode clusters. Each center gives us insight into what user behavior looks like on weekdays or weekends. Figure 3 shows the two cluster composition. The activity level data was also transformed using Fast Fourier Transform Based on the computed behavior modes, when we ran sub-clustering to extract activity recipes for each user we found a varying number of activity recipes across the users. Fig. 4 shows the diﬀerent activity recipes generated for each behavior mode, with varying levels of light, moderate and vigorous activities. These ﬁgures accurately depict that activity recipes have a strong correlation with the behavior modes. That is activity recipes for behavior modes with less overall activity also have fewer minutes for moderate and vigorous activity. tering and Euclidean produced the best results among all the clustering techniques, i.e. the purest clusters for good and poor sleep. Based on these clusters, good sleep recipes were determined, which indicate the diﬀerent activities and the duration of each of those that should be carried out to ensure good sleep. be performed. As it was an oﬄine evaluation, we could not test how the subjects would perform in real-time, i.e. whether they would follow the given recommendation or not, and what the outcome was if the recommendation To determine activity recipes, various distance metrics were used for clus- Since this work was not on streaming data, online evaluation could not was followed, versus when it was not followed. Instead, retrospective evaluation (Sathyanarayana, 2017) was used to ﬁnd subjects with the closest activity pattern and the quality of subsequent sleep to decide if the recommendation was successful or not. Fig. 5 shows one such set of recommendations that were generated based on the target user’s activity time series till the middle of the day. The left ﬁgure is for the target user’s existing activity categorized into activity labels, while the right ﬁgure presents a list of activity recommendations, ordered by their proximity to the input data. Our team has been working on an activity recommendation engine for quite some time and has progressed slowly from a purely hypothetical design to data-driven development. Our initial hypothesis for building the activity recommendation engine was to group similar people (clustering) based on their cardiovascular health using their Heart Rate time series data for the day and then sub clustering these groups based on similar aggregated activity levels to learn activity recipes for good sleep. This hypothesis was then extended to include a parallel pipeline that learns the behavior modes for each person based on their activity time series for the whole day and performs similar sub clustering. The activity recommendation engine then evolved to recommend activities based on an overall evaluation of sleep recipes determined for each pipeline using their distances from cluster centers. With the updated model, we could provide personalized activity recommendations while making sure to fall back to generalized activity recommendations based on other users if there was an anomalous day for that user. To conﬁrm the validity of our hypothesis, we built the activity recipe extractor model over our custom Fitbit data. We built a data hosting server that periodically collected minute-level heart and activity data from Fitbit watches worn by students who volunteered to participate in our research. Once we collected enough data (around 4 months’ worth), we were successfully able to identify behavior modes for all the users. It was veriﬁed by the subjects that behavior modes identiﬁed coincided with their weekly schedules. Apart from this, heart rate clustering also helped successfully group similarly aged people into clusters. We also learned various activity recipes which seemed to be in line with the students’ schedules over the semester. This experiment helped reaﬃrm our hypothesis.However, the dataset that we worked with was not large enough to build a robust model on.Hence we decided to explore other datasets that have actigraphy data along with heart rate data available for a suﬃciently large group of people to build our activity recommendation engine. We then continued our eﬀorts using the HCHS/SOL dataset. After moving to the HCHS/SOL dataset, we found out was that the heart rate PSG data for the users corresponded to their baseline visit and was for a single sleep session. The baseline visit for the users also did not align with their actigraphy data. Due to the nature of this dataset, we removed the ﬁrst step in our original activity recommendation pipeline - clustering users based on similar cardiovascular health. In our project, we evaluated the performance of many diﬀerent clustering algorithms using diﬀerent distance metrics over the simple time-series data (minute level), and over the principal frequencies of the time series obtained using FFT. However, we also performed some feature extraction from the time series using an LSTM Autoencoder. LSTM Autoencoder helped us reducer the dimensionality of the minute-level time series and extract meaningful information. This was done because clustering in higher dimensions is much more complex. Using LSTM Autoencoders also helps us learn features independent of each other, unlike time series, thus making sure simple distance metrics like L2 norm are eﬀective in ﬁnding similarity and dissimilarity among the records. et al (2015) which uses a repeated LSTM unit to reconstruct the entire sequence as well as predict the future sequence. Architecture for the composite LSTM model can be seen in Fig. 6. Training for the model was done to minimize the overall mean squared error (MSE) loss for these parts (reconstruction and prediction units). The technique we used was a Composite LSTM Autoencoder Srivastava training, validation, and test for 300 epochs, the MSE error over the test set was down to 0.005. Example of a prediction for reconstruction and future values can be found in Fig. 7. One thing to note is that the heart rate values were scaled using a MinMaxScaler to bound them to a range of [0, 1] to avoid the problem of vanishing/exploding gradient. sults that we obtained from clustering over the raw time-series data. We think that because the number of records for our training was quite low compared to what a model like this expects, it had overﬁtted the data due to which the learned features resulted in clustering similar to the non-deep methods for clustering (section 5.3). In this paper, we presented a novel approach for goal-directed personalized activity recommendations that ﬁnds activities most closely aligned with a user based on activities done thus far, as well as any health constraints the user might have. and care providers (doctors, nurses, family) for their subjects for improving their physical and mental health through personalized recommendations for goals tailored to the end-user. jects had two behavior modes based on the number of clusters generated, which reinforced our initial hypothesis that people generally have a cyclic behavior that varies on weekdays and weekends (Pierson et al, 2018). recipes for good sleep, which denoted diﬀerent types of schedules. The activity recipes included a mix of intense and light activities that led us to conclude that people could have a variety of activity types, and varying amounts of these activities could all lead to good sleep. Ongoing work includes adding a feedback loop to our recommendation engine that will continuously recommend activities to users (for example, every 2 hours) and using actions of the users upon receiving the recommendation for subsequent recommendations. the activity recipe recommendations resulted in good sleep. Another direction for this research is running experiments with other goals. are better suited for handling high dimensional datasets just like the time After training our LSTM model over a 60:20:20 split of the dataset as However, the clustering results for the extracted features resembled the re- This work will provide a system to be used by individuals for themselves, Based on experiments on the HCHS/SOL dataset, we concluded that sub- Using a clustering-based approach helped us in ﬁnding numerous activity Retrospective evaluation will also be used on existing data to test whether We also want to explore diﬀerent clustering algorithms in the future which series dataset we have. Finally, we want to invest some time in other ways of feature extraction to complement the clustering.