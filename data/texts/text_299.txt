Astronomisches Rechen-Institut, Zentrum für Astronomie der Universität Heidelberg, Mönchhofstraße 12-14, 69120 Heidelberg, Germany School of Physics and Astronomy, University of St Andrews, North Haugh, KY16 8SS, St Andrews, UK Sterrenkundig Observatorium, Universiteit Gent, Krĳgslaan 281, B-9000 Gent, Belgium The radiative feedback of high-mass stars can have profound impact on the formation of stellar and planetary systems, as well as on the interstellar environment. Ionising radiation has been shown to be able to externally photoevaporate protoplanetary discs (O’dell & Wen 1994; Scally & Clarke 2001), to restrict the mass accretion onto the source star (Kuiper & Hosokawa 2018; Sartorio et al. 2019) and deplete some of the available gas for further star formation (Dale et al. 2012; Walch et al. 2012; Ali & Harries 2019; Decataldo et al. 2019). The presence of high-mass stars has also been argued to aﬀect the star formation rate (SFR) in their surroundings. Star formation may be triggered via the collect-and-collapse mechanism, which occurs when the shock swept up by an expanding H II region collects suﬃcient amounts of mass to become gravitationally unstable and E-mail: maya.petkova@uni-heidelberg.de (MAP) © 2021 The Authors collapse. This mechanism was ﬁrst introduced by Elmegreen & Lada (1977), and was expanded by later studies with numerical models, which showed that the masses of the newly produced stars depend on the thickness of the shocked shell (Wünsch et al. 2010; Dale et al. 2011). Another way of triggering star formation can be achieved through radiation-driven implosion, during which preexisting cloud cores become unstable under gravity as they get compressed by an expanding H II region (Kessel-Deynet & Burkert 2003; Mellema et al. 2006; Bisbas et al. 2011). However, ionising feedback is mainly expected to have a negative eﬀect on the SFR by altogether dispersing the cloud containing the source stars (Dale 2015; Kruĳssen et al. 2019b; Chevance et al. 2020). In order to study the above mechanisms, many diﬀerent methods of incorporating ionising feedback into hydrodynamics simulations have been developed. Early work by Lucy (1977) and Brookshaw (1994) described the propagation of light as a diﬀusive process, which could be included directly into the hydrodynamics equations. The diﬀusion approximation only holds for an optically thick medium, and it was later equipped with a ﬂux-limiter in order to handle optically thin environments, giving rise to the ﬂux-limited diﬀusion method (e.g. Levermore & Pomraning 1981). Other authors have traced rays of light through the diﬀuse medium and computed the ionisation state of the material along them. This can be achieved either by following the ray from the source to a given point (e.g. Kessel-Deynet & Burkert 2000; Abel & Wandelt 2002; Dale et al. 2005; Pawlik & Schaye 2008; Wise & Abel 2011; Haid et al. 2019), or by starting from a chosen point in space and following a ray back to its source (Grond et al. 2019). In recent years, there have been eﬀorts towards using Monte Carlo Radiative Transfer (MCRT) in combination with hydrodynamics codes, since MCRT treats radiative eﬀects (such as casting of shadows) with high accuracy (Harries 2015; Vandenbroucke & Wood 2018). Such radiation-hydrodynamics (RHD) schemes have been successfully implemented for grid-based (Harries 2015; Smith et al. 2017) and moving mesh (Vandenbroucke & Wood 2018; Smith et al. 2020) hydro codes, but are still under development for Smoothed Particle Hydrodynamics (SPH) codes. This is due to the particle nature of SPH and the fact that, with a few exceptions (Forgan & Rice 2010; Lomax & Whitworth 2016), MCRT algorithms are typically performed on a grid. In this work we present for the ﬁrst time a numerical scheme combining SPH and MCRT for modelling ionising radiation "on the ﬂy". In order to reconcile the particle- and grid-based descriptions of the diﬀuse medium we have employed the use of Voronoi grids, which have been successfully used by other authors for postprocessing SPH snapshots (e.g. Hubber et al. 2016; Koepferl et al. 2017). We test the scheme by successfully applying it to the wellstudied problem of spherical expansion of an H II region. Furthermore, we perform simulations with varying time step associated with the radiative feedback, spatial resolution, and properties of the interconnecting Voronoi grid, in order to ﬁne tune the scheme’s performance. Finally, we apply our RHD method to a non-uniform density medium, in order to study the eﬀects that an ionising source would have on the galactic centre cloud G0.253+0.016 (also known as the Brick). The Brick is a high–density cloud in the Central Molecular Zone (CMZ) of our galaxy, and it is believed to be a likely progenitor of a future high–mass stellar cluster (Longmore et al. 2012; Rathborne et al. 2015; Walker et al. 2015). Despite its high density, the cloud shows limited signs of ongoing star formation (Walker et al. 2021), and does not yet contain any identiﬁed H II regions. Therefore, the Brick is a unique system that may provide the initial conditions for H II region formation and early evolution. Furthermore, similarly to the rest of the CMZ, the Brick has high density, pressure and temperature (Ginsburg et al. 2016; Krieger et al. 2017; Barnes et al. 2020), which are representative features of high-redshift star-forming environments, and hence we can probe the early evolution and impact of H II regions under conditions characteristic of high-redshift galaxies (Kruĳssen & Longmore 2013). In particular, the following questions of interest arise: (i) What will be the ionised mass of a newly formed H II region? (ii) How rapidly will the ionised mass increase? This paper is organised as follows. We describe the numerical setup and the simulation parameters in Section 2. We then present the simulations in uniform density medium in Section 3, followed by the simulations in clumpy medium in Section 4. Finally, we summarise our ﬁndings and give recommendations for future RHD simulations in Section 5. Figure 1. Code structure of the RHD scheme. During each simulation, Phantom performs hydrodynamics calculations and it ouputs its particle parameters in dump ﬁles at regular time intervals. We use the “live analysis” feature to externally modify some particle properties, each time a dump ﬁle is created. The modiﬁcation is performed by calling CMacIonize in its library form and passing on particle positions and smoothing lengths. In addition, our analysis script outputs a parameters ﬁle and a Voronoi grid ﬁle, which are necessary for the function of CMI. Finally, CMI performs a radiative transfer calculation and it returns ionic fractions for all particles, which are used for modifying the particles’ internal energies. In this paper, we combine a Smoothed Particle Hydrodynamics (SPH) code and a Monte Carlo Radiative Transfer (MCRT) code in order to produce a radiation-hydrodynamics (RHD) scheme. This is achieved by linking the two codes in the following way. During the runtime of the SPH code its particle distribution is used to construct a Voronoi grid (Voronoi 1908). The particle positions, smoothing lengths and masses are then used for calculating the density of each cell. The grid information is passed on to the MCRT code, which computes the ionic fraction of each grid cell by propagating a large number of photon packets through the Voronoi grid. The ionic fraction is mapped from the grid cells to the SPH particles, and this information is returned to the SPH code. Finally, the particles’ internal energies are adjusted according to the ionic fraction. Each of the above steps is explained in greater detail later in this section. We use the Phantom SPH code (Price et al. 2018) for our RHD scheme. As a typical SPH code, it follows a set of Lagrangian particles and it integrates the corresponding ﬂuid equations. Phantom was created with a focus on stellar, planetary and galactic astrophysics. The code is well suited for the study of star formation as it is three-dimensional and it includes the treatment of self-gravity, sink particles and gas-dust mixtures. Additionally, it can be run as both ideal and non-ideal MHD. Crucially for our work, Phantom can execute an analysis module, which is typically used to postprocess the SPH outputs (dump ﬁles). There is a "live analysis" option, which ensures that the analysis module is executed during Phantom’s runtime. The MCRT code that we have used is CMacIonize (Vandenbroucke & Wood 2018). CMacIonize (CMI) models photoionisation on a variety of 3D grid structures, including Cartesian, AMR and Voronoi grid. The code uses two Voronoi grid construction algorithms: an incremental construction algorithm, based on the publicly available Voro++ library (Rycroft 2009), and a Delaunay tessellation based algorithm, similar to Springel (2010) and Vandenbroucke & De Rĳcke (2016). CMI contains a radiation hydrodynamics scheme in itself, allowing the user to choose between a ﬁxed grid and a moving mesh grid hydrodynamics. The code models the photoionisation of hydrogen and helium self-consistently in the energy range between 13.6 and 54.4 eV. The ionisation states of a number of metal ions are modelled approximately, as they contribute to the cooling of the gas. Presently there is no treatment of lower energy photons, dust or radiation pressure (for more information see Vandenbroucke & Wood 2018). Additionally, CMI exists in a library form, which allows it to be called from other C or Fortran programs. The MCRT algorithm works as follows (see Sec. 2.1.1 of Vandenbroucke & Wood 2018). A large number of photon packets are emitted from one or multiple sources. The properties of each photon packet (i.e. origin, direction and wavelength) are sampled using the Monte Carlo technique. Each photon packet is then propagated through the density grid until a randomly sampled optical depth is reached or until the photon packet exits the grid. The algorithm accumulates the path lengths of the photon packets that pass through each cell to obtain an estimate of the local ionising ﬁeld (Lucy 1999) from which the ionisation state can be calculated. Once a photon packet reaches its sampled optical depth, it is absorbed, and it may be re-emitted if a recombination event occurs locally. This newly emitted photon packet is propagated further if its frequency is high enough to cause ionisation (otherwise the photon packet escapes the simulation without contributing to the ionisation state of the diﬀuse medium). The photon packets created by recombination events are collectively known as the “diﬀuse ﬁeld”. In the simulations that we present here we omit the diﬀuse ﬁeld for consistency with the StarBench test (see Section 3). However, it is trivial to take it into account in future work, as it is controlled by a standard CMacIonize input parameter. The process described above, involving the random sampling and propagation of photon packets, is performed iteratively. At the beginning of the ﬁrst iteration, CMacIonize assumes that all of the grid cells are fully ionised, and they are assigned an appropriately high temperature. After the propagation the of photon packets, the ionic fraction and the temperature of each grid cell is updated. After a number of iterations (typically ∼ 10), the ionic fractions and temperatures converge. Note that if we run CMacIonize with a diﬀuse medium consisting only of hydrogen, the temperature of the ionised gas is set to a constant value (usually 10K), while if we assume a mix of elements, the temperature is computed iteratively. Despite the fact that CMacIonize has its own cell temperatures, we do not take these values into account in our simulations and we leave it up to the hydrodynamics to assign the gas temperatures based on a particle’s ionic fraction. This is done for consistency with the StarBench setup. The connection between the two codes is established by using MNRAS 000, 1–22 (2021) Phantom’s option for performing live analysis and CMacIonize’s library functionality (see Figure 1). The CMI library is called as part of Phantom’s analysis module, which passes along information about the SPH particle positions, masses and smoothing lengths, and receives the neutral hydrogen fraction of each particle. The module then uses the neutral hydrogen fractions in order to modify the internal energies of the SPH particles in Phantom. Additionally, the analysis module generates a CMacIonize parameters ﬁle necessary for the execution of the MCRT, together with a ﬁle containing the positions of a set of Voronoi cell generating sites. This particular way of linking the two codes uses a ﬁxed time step for the radiative feedback, which coincides with the SPH output frequency. Care has been taken when choosing the appropriate time step, and we will address this further in Section 3. A Voronoi grid is a structure consisting of polyhedral cells built around a set of generating sites, such that each cell wall bisects the distance between two neighbouring sites (Voronoi 1908). This means that the choice of generating sites uniquely deﬁnes the grid and its structural properties. In this work we have used two diﬀerent choices of generating sites and have compared how the simulation outcome depends on the grid. The ﬁrst type of grid that we have used is one where the generating sites coincide with the particle positions. This is the most intuitive and basic way of constructing a Voronoi grid from a set of particles, and it ensures that the concentration of grid cells follows that of the particles. This type of grid, however, has a known issue when large density gradients are present. The cells at the interface between low density and high density material become elongated and under-resolve the interface (Koepferl et al. 2017). Since a large density gradient is to be expected in our simulations, we have also considered a regularisation of the grid in order to improve the resolution. The regularisation has been performed using Lloyd’s algorithm (Lloyd 1982), which is an iterative process. At each iteration the generating sites of the cells are moved to the cell centroids and the grid is subsequently reconstructed. For the simulations presented here we have used ﬁve Lloyd’s iterations, which have been suﬃcient to alter the grid structure signiﬁcantly (see Section 4). A 2D illustration of the Lloyd’s algorithm is shown in Figure 2. In the left panel of the ﬁgure, we have randomly sampled x- and y-positions for a set of generating sites (marked with blue circles), and we have constructed a Voronoi grid around them. Note that we have sampled 100 generating sites with coordinates between −0.5 and 1.5, but we only show the [0,1] range in x- and y-coordinates, in order to avoid boundary eﬀects. The left panel also contains the positions of the cell centroids, shown in grey circles. We can see that the less circular cells typically have greater distances between their generating sites and their centroids. This is also emphasised by the cell colour, which corresponds to the distance between a cell’s generating site (positioned at r) and its centroid (positioned at r) divided by the cell size (𝐴, where 𝐴is the cell area). In the right panel of Figure 2 we plot the same grid after one iteration of Lloyd’s algorithm. This means that we take the generating sites from the left panel and we move them to the centroids of their corresponding cells. We see that the grid cells in the right panel are a lot more circular than those in the top one, and have centroids which are much closer to their generating sites. For both choices of generating sites in our simulations, the grids Figure 2. An example of a 2D Voronoi grid generated around randomly sampled points (left), and its regularised counterpart (right). In both panels, the grid generating sites are marked with blue circles, and the centroid of each grid cell is marked with a grey circle. The centroid points of the left panel serve as generating sites for the right panel (i.e. one Lloyd iteration has been performed going from left to right). The colour of each grid cell indicates the distance between the generating site and the centroid in units of the cell size. have been constructed using the direct incremental construction algorithm that is part of CMacIonize, and that is based on the publicly available Voro++ library(Rycroft 2009). Once the Voronoi grid is constructed, we need to assign densities to the cells. We have employed three diﬀerent types of density mapping, in order to test the robustness of the simulation outcome. The ﬁrst density mapping takes advantage of the fact that there is one grid cell per particle, and the cell density is given as the particle mass divided by the cell volume, or where ‘𝑎’ is the index of the particle and ‘𝑖’ is the index of its corresponding cell. This method (labelled as ‘M/V’) is very quick and easy to compute, however it is prone to large uncertainties since there is no direct correspondence between a particle’s smoothing length and the volume of its Voronoi cell. Also note that we can only apply it to the non-regularised Voronoi grid because after Lloyd’s algorithm is applied not all cells necessarily contain exactly one particle, and we lose the correspondence between ‘𝑎’ and ‘𝑖’. The second density mapping method (labelled as ‘Centroid’) uses the SPH density estimated at the cell’s centroid. The cell density is given by: where ‘𝑖’ is the index of the cell with a centroid position at r, rand ℎare the position and smoothing length of particle ‘𝑎’, 𝑁 is the total number of particles, and 𝑊 is the kernel function. http://math.lbl.gov/voro%2B%2B/ Note that when we use a kernel function which goes to zero for large radii (i.e. a kernel function with compact support), only some of the particles have non-zero contributions to the above sum. If rwas the position of a For all of our simulations we have used a cubic spline form for 𝑊 (Monaghan 1985), which goes to zero for distances to the particle greater than 2ℎ. This mapping method is more consistent with how SPH uses densities, and it only requires slightly longer to compute than the previous method. The downside is that it does not conserve mass when mapping the particle densities onto the cells. Note that the magnitude of the error in the total mass depends on the particle distribution, and the Voronoi cell arrangement. Moreover, the error in the total mass is typically diﬀerent at each ionisation time step, as the particles have rearranged themselves, and it is not cumulative as the simulation progresses. Finally, we have also used density mapping (labelled as ‘Exact’) which computes the exact average SPH density within the grid cell, as derived in Petkova et al. (2018). The method calculates the integral of the kernel function over the cell volume, and it relates it to the cell density by: Unlike the previous density mapping method, this one conserves the total mass when computing cell densities, which ensures better accuracy when performing the radiative transfer. For computational eﬃciency the values of the integral of the cubic spline kernel function have been pre–computed and used for interpolation. Even so, however, this method remains many times slower then the ﬁrst two (see Appendix A). particle, we would refer to the particles with non-zero contributions as that particle’s neighbours. 𝑁 could then be replaced by 𝑁in the above sum. A particle in our simulations has on average 58 neighbours. After the CMI library computes the ionic fraction of each grid cell, these values have to be mapped onto the particles. Analogously to the previous section, we have used three diﬀerent ways of performing the ionic fraction mapping depending on the choice of density mapping. The ﬁrst type of density mapping (‘M/V’; given by eq. 1) assumes that a particle and its corresponding cell contain the same amount of mass, and hence we can assume that they also contain the same amount of ionised mass. This leads to their ionic fractions being identical: In the second type of density mapping (‘Centroid’; eq. 2) we can think of each particle as contributing to the density of each cell that it overlaps with. If we multiply these density contributions with the corresponding cell volumes and ionic fractions, they become ionised mass contributions. The inverse mapping for this method is then given by: Note that the denominatoris included in order to ensure that the particle’s ionic fraction could not exceed the value of 1. Additionally, since the corresponding method of density mapping does not conserve mass, this type of ionic fraction mapping does not conserve ionised mass either. Finally, in the exact density mapping (‘Exact’; eq. 5) each particle contributes a fraction of its mass to the grid cells it overlaps with. By multiplying this fractional mass contribution with the ionic fraction of the corresponding grid cell, we can construct a mapping which conserves the ionised mass: We present two sets of simulations – one reproducing the D-type expansion of an H II region in a uniform medium, and one ionising a clumpy, star-forming cloud in the galactic centre. For consistency and ease of comparison we have kept most of the physical parameters the same between the two sets (see Table 1). The individual setups are presented in more detail in the beginning of Section 3 and 4. In all simulations CMacIonize has been performed with 10 iterations of 10photon packets each, in order to compute accurate ionic fractions. In all of our simulations we disregard the diﬀuse ﬁeld and invoke the B-case recombination coeﬃcient, 𝛼= 2.7 × 10cms, which corresponds to an ionising temperature of 𝑇= 10K (Osterbrock 1989). This assumes that any ionising photon released by a recombination event is absorbed locally (i.e. the It is possible, in rare cases, that the denominator could be zero. This happens if a particle’s kernel function does not overlap with the centroid of any of the cells. In these cases, we conservatively assume that the aﬀected particles are neutral. If we have one odd neutral particle within an H II region, the dynamics of the gas will not change signiﬁcantly, but even a single ionised particle in the middle of a neutral region can drive some local expansion. MNRAS 000, 1–22 (2021) Table 1. Physical parameters for the two sets of simulations. ¤105 × 10 𝜌g cm5.21 × 10so-called “on-the-spot” approximation). The photoionisation crosssection is assumed to be 𝜎 = 6.3 × 10cm. For the hydrodynamics we have used a polytropic equation of state with 𝛾 = 1.00011 in order to mimic two-temperature isothermal gas, even though the exact value of 𝛾 does not aﬀect the H II region expansion signiﬁcantly, according to the models included in Bisbas et al. (2015). The gas is composed purely of atomic hydrogen (𝜇= 1). After each time CMacIonize is called, the particles with ionic fraction higher than 0.5 have their internal energies set to correspond to a temperature of 𝑇= 10K and a mean molecular weight of 𝜇= 0.5. This creates a high temperature (and energy) contrast between some neighbouring particles, which is commonly known in SPH as “contact discontinuity”. In order to minimise numerical issues that may arise from the presence of this contact discontinuity, we include artiﬁcial thermal conductivity (with 𝛼 = 1), which has been introduced as a necessary numerical correction by Price (2008). In this section, we present a set of simulations of a single ionising source in a uniform density medium (labelled as ‘SB’; see Table 2). We adopt the setup of (Bisbas et al. 2015, StarBench), who established a benchmark test by performing simulations with a number of diﬀerent 1D and 3D hydrodynamics codes coupled with ionising feedback. To reproduce their setup we have constructed a cube of uniform density (𝜌= 5.21 × 10g cm) with a source of constant ionising luminosity (¤𝑄 = 10s) in the centre. The SPH particles have been initially arranged in a glass distribution (available as part of the public simulation code SWIFT; Borrow et al. 2018) to reduce numerical noise. All particles are initially at rest and have a temperature of 𝑇= 100 K. The simulation volume has a side 𝑅, and total mass 𝑀, where 𝑀= 𝜌𝑅and the total number of particles, N, is chosen so that the particle mass is 𝑚≈ 10M. We have used periodic boundary conditions to ensure that the cubic volume of gas does not diﬀuse out due to a pressure gradient. In order to avoid numerical inaccuracies, we have stopped each simulation before the point where the shock reaches the edge of the cube. The ionising emission of the source creates a spherical H II region, which undergoes rapid expansion. Determining the time evolution of the H II region is a very well known problem, which has been studied extensively, both theoretically (Spitzer 1978; Hosokawa & Inutsuka 2006; Raga et al. 2012a,b; Williams et al. 2018) and numerically (Bisbas et al. 2015). We begin this section by reviewing the theoretical work, which lays the foundation for interpreting our simulation results. We then demonstrate that our main simulation (‘SB I’) is in good agreement with the theory, as well as previous Table 2. List of the RHD simulations included in this paper, and their setup. The particle mass is denoted as 𝑚 time is 𝑡. The mass of the full simulation box is 𝑀, and it has a side of 𝑅. Note that for all ‘SB’ simulations the mean initial density, 𝜌 and hence the ratio 𝑀/𝑅remains constant. numerical work (Bisbas et al. 2015). For completeness, we also perform a much longer simulation (‘SB Ia’) which matches the ‘late test’ from Bisbas et al. (2015). In the remaining subsections we present variationsof ‘SB I’, in which we alter the ionisation time step (Section 3.3), grid type and density mapping method (Section 3.4), and resolution (Section 3.5). These additional simulations allow us to formulate recommendations for future applications of the radiation-hydrodynamics scheme, which we list in Section 5. Let us consider an idealised scenario of a pure atomic hydrogen cloud of constant density with an embedded high mass star. The cloud is initially completely at rest, and we will ignore the eﬀects of gravity. As the star begins to emit ionising radiation, an increasingly large spherical region around it will become ionised, until the amount of ionised gas is large enough that the hydrogen recombination rate will balance out the ionisation. This is achieved at the Strömgren radius (Strömgren 1939): where¤𝑄 is the number of ionising photons coming from the star per unit time, 𝑚is the hydrogen mass, 𝜌is the density of the medium and 𝛼is the recombination coeﬃcient. In all of the simulations derived from ‘SB I’, we only focus on the ﬁrst 0.04 Myr of the early StarBench test, since this is the time of most rapid expansion and we expect to see greatest variation with the choice of time step, grid/density mapping and resolution. The D-type expansion of an H II region begins after the Strömgren radius is reached, and it is caused by the pressure imbalance between the hot, ionised material, and the cold, neutral gas, forcing the ionised gas to expand. The expanding material moves supersonicly into the neutral gas and it sweeps up material to form a thin shock that precedes the ionisation front (Kahn 1954). The rate of expansion of the H II region described above has been the subject of many studies. By considering the pressure of the ionised gas and the ram pressure experienced by the neutral gas as the shock sweeps through it, we can arrive at the Spitzer solution for the radius of the ionisation front (Spitzer 1978): where 𝑐is the sound speed in the ionised medium. The Spitzer solution was later improved by Hosokawa & Inutsuka (2006), who noticed that the inertia of the shock promotes additional expansion. By solving the equation of motion of the shock, they obtained the Hosokawa-Inutsuka solution (Hosokawa & Inutsuka 2006): The above equations provide good description of the early time expansion of an H II region. If they are followed to later times, however, their functional form predicts that the H II region will continue to expand inﬁnitely. This is not what we expect, since the ionised material should eventually reach a pressure equilibrium with the neutral cloud. Raga et al. (2012b) have addressed this issue by Figure 3. Density slices at 𝑧 = 0 of a simulation of the early StarBench test, computed with our RHD scheme (‘SB I’; see Table 2). Each panel corresponds to a diﬀerent simulation snapshot, as labelled in the ﬁgure. The grey line marks the position of the ionisation front. Note that only one quadrant of the density slices is displayed. including the thermal pressure of the neutral gas into the equation, governing the expansion of the ionisation front, 𝑅: In the above, 𝜇and 𝜇are the mean molecular weights of the neutral and the ionised gas, and 𝑇and 𝑇are the neutral and ionised temperatures respectively. We can argue that typically 𝜇𝑇/(𝜇𝑇)  1 since 𝑇 𝑇. Therefore, at early times 𝜇𝑇/(𝜇𝑇)(𝑅/𝑅(𝑡))can be neglected and then equation 12 leads to the Spitzer solution. Raga et al. (2012a) improved on the work of Raga et al. (2012b) by including the inertia of the expanding shock, as it propagates through the neutral medium. Their consideration leads to an expansion equation: Similarly, at early times the term 𝜇𝑇/(2𝜇𝑇) can be neglected, which is equivalent to neglecting the thermal pressure of the neutral gas. Equation 13 then leads to the Hosokawa–Inutsuka solution. The late time behaviour of an H II region was further studied by Williams et al. (2018), who developed a thick–shell solution capturing the decoupling of the ionisation front and the shock front. Even though this solution was intended for improving the late time evolutionary model of an H II region, it is also relevant for our early time numerical studies with particle–based hydrodynamics, where we see thick shocks forming early on. Williams et al. (2018) point out that the Hosokawa–Inutsuka solution does not distinguish between the position of the shock front and the position of the ionisation front, since the shock is initially very thin. As we will see further in the paper, the thick shocks produced by the particle– based hydrodynamics will result in slightly smaller H II region sizes than expected. Finally, Williams et al. (2018) use an acoustic approximation to demonstrate that at ﬁrst the stagnation radius is MNRAS 000, 1–22 (2021) exceeded by the expanding H II region, which subsequently shrinks until it reaches its ﬁnal size through a strongly damped oscillation. We now demonstrate that the new radiation-hydrodynamics scheme presented in this paper reproduces the well-established StarBench ‘early test’ (Bisbas et al. 2015), using a simulation setup with 𝑁 = 128, 𝑚= 10Mand ionisation time step 𝛿𝑡 = 8.5×10Myr (‘SB I’; see Table 2). Figure 3 shows density slices at 𝑧 = 0 of the simulation at diﬀerent times. We can see that qualitatively the D-type expansion is reproduced correctly, as an initially spherical region expands rapidly and sweeps up a shell of shocked gas. It can also be noticed that the shock is relatively thick even at the early stages of its formation. This is due to the use of SPH, and results in a slight suppression of the ionisation front, as discussed by Bisbas et al. (2015). In order to quantify the rate of expansion, we have determined the position of the ionisation front by selecting particles with ionic fractions between 0.2 and 0.8, and averaging their radial distance from the source. Note that there is a sharp transition between fullyionised and neutral particles as a function of radius, and therefore the exact range of partial ionisation used to determine the position of the ionisation front, does not alter the result signiﬁcantly. This procedure has been repeated for each SPH snapshot to produce the time evolution of the ionisation front presented in Figure 4 (the position of the ionisation front is also shown in the four snapshots of Figure 3 as a grey line). Additionally, the top panel of Figure 4 contains the analytic curves of the Spitzer and Hosokawa-Initsuka solutions (see equations 10 and 11), and the average, empirically derived expansion curve from the StarBench paper (Bisbas et al. (2015)). In the bottom panel we present the relative error of the ionisation front radius compared to the two theoretical solutions. Note that in the label 𝑅refers to the Phantom + CMacIonize solution, while 𝑅refers to one of the theoretical solutions. Initially, the expansion of the ionisation front in our simulation happens more slowly than the one predicted by the theoretical Figure 4. The expansion of an H II region, following the StarBench setup (‘SB I’; see Table 2). Top: ionisation front radius as a function of time. The Spitzer and Hosokawa-Inutsuka solutions are shown in dashed lines, the averaged 3D StarBench solution is in solid grey (Bisbas et al. 2015), and the Phantom + CMacIonize live radiation hydrodynamics scheme is shown in solid black line. Bottom: the relative error of the Phantom + CMacIonize solution compared to the Spitzer (red) and Hosokawa-Inutsuka (blue) solutions. In the label, 𝑅refers to the Phantom + CMacIonize solution, while 𝑅refers to one of the theoretical solutions. models, however, the size of the ionised region soon reaches a value between the Spitzer and Hosokawa-Initsuka solutions. Similar behaviour can be seen in the average StarBench solution, even though their curve remains slightly above ours at all times (see Figure 4). This slight discrepancy is attributed mainly to the thicker shocks produced by SPH, as already mentioned above, but it could also be aﬀected by the choice of ionisation scheme. In Figure 3 we see that the peak of the shock and the position of the ionisation front are separated by a medium-density shock tail. A diﬀerent ionisation scheme might place the ionisation front closer to the shock, making the results more consistent with the StarBench paper. In addition to the ‘early test’, we also perform the ‘late test’ from the StarBench study (‘SB Ia’; see Table 2). The simulation setup uses 𝑁 = 512particles with masses 𝑚= 10M. The time step is 𝛿𝑡 = 1.36 × 10Myr, and we evolve the simulation for 2.5 Myr, which allows us to observe the equilibrium state of the H II region. Note that the initial gas temperature in this test (𝑇= 1000 K) is higher than in ‘SB I’ in order for the equilibrium state to be reached sooner. The late test captures the decoupling of the shock and the ionisation front. While the former continues to propagate through the neutral medium, the latter settles into an equilibrium state. This behaviour can be seen in Figure 5, which shows density slices at different times, similarly to Figure 3 for the early test. The decoupling mentioned above occurs between the second and the third panel of Figure 5. In addition, we show the time evolution of the radius of the H II region in Figure 6. The ﬁgure demonstrates an excellent agreement between our results (in black) and the StarBench data (in grey). Furthermore, we see that the expansion curve from our simulation follows the Spitzer and the Hosokawa-Inutsuka solutions at early times. As the shock thickens (at ∼ 0.2 Myr), the expansion curve deviates from these solutions, as expected. Next we will examine the sensitivity of the simulation outcome to the choice of ionisation time step, 𝛿𝑡. We have performed a series of small-scale simulations (𝑁 = 64, 𝑚= 10M), with 𝛿𝑡 ranging between 1.7 × 10Myr and 1.36 × 10Myr (‘SB II’ to ‘SB VI’; see Table 2). Note that all time steps have been chosen to be smaller than 1.7 × 10Myr, since using time steps larger than this critical value causes poor energy conservation and prompts errors in Phantom. This is a byproduct of the initial energy discontinuity between the ionised and the neutral medium (see Price et al. 2018 for more details). Figure 7 presents the expansion curves of the aforementioned simulations, and it shows good agreement between them. Within the ﬁrst few time steps (𝑡 < 0.002 Myr) the curves overlap completely, and after that (𝑡 < 0.007 Myr) a small oﬀset develops between them. The time period of oﬀset development corresponds to the most rapid expansion of the H II region within the simulations (see the top panel of Figure 8). Once formed, the small oﬀset remains between the curves for the rest of the simulation time. We can explain this good convergence by considering a timestepping condition for the ionisation similar to the Courant criterion (Courant et al. 1928). In order to ensure numerical convergence, we want the ionisation front to expand by at most the local particle/Voronoi cell separation between two consecutive ionisation time steps, i.e.: In the above 𝑣is the speed of the ionisation front, ℎis the smoothing length of particle ’a’, located at the periphery of the ionisation front, and 𝑙is the size of the co-spatial Voronoi cell. The diﬀerence between eq. 14 and the Courant criterion is subtle. The latter uses the (absolute or relative) velocity of a particle, while the former considers the speed of the ionisation front, which can advance independently from the particles. In Figure 8 we have tested that the above condition holds for all of the timestepping test simulations. In the top panel we have plotted 𝑣/𝑐as a function of time, both calculated as average speed between consecutive snapshots, and estimated theoretically from the Spitzer and Hosokawa-Inutsuka solutions. The estimates have been obtained using equations 10 and 11, from which we can write the time derivatives of the H II region radius as: Figure 5. Density slices at 𝑧 = 0 of a simulation of the late StarBench test, computed with our RHD scheme (‘SB Ia’; see Table 2). Each panel corresponds to a diﬀerent simulation snapshot, as labelled in the ﬁgure. The grey line marks the position of the ionisation front. Note that only one quadrant of the density slices is displayed. Figure 6. The late-time expansion of an H II region, following the StarBench setup (‘SB Ia’; see Table 2). The Spitzer and Hosokawa-Inutsuka solutions are shown in dashed lines, the averaged 3D StarBench solution is in solid grey (Bisbas et al. 2015), and the Phantom + CMacIonize live radiation hydrodynamics scheme is shown in solid black line. This results in¤𝑅(𝑡 = 0) = 𝑐and¤𝑅(𝑡 = 0) =4/3𝑐, and decreasing expansion rates for 𝑡 > 0. Numerically (and physically), however, the gas is initially at rest. As a result, the initial expansion of the H II region does not happen as rapidly as predicted, and the calculated value of 𝑣remains lower than 𝑐at all times. The middle panel of Figure 8 presents the Voronoi cell size immediately outside the ionisation front as a function of time. These cells are located around the inner edge of the shock and have been selected as having ionic fractions between 0.3 and 0.5. Due to the MNRAS 000, 1–22 (2021) irregular shapes of Voronoi grid cells, the average cell size has been calculated as the average cube root of the cell volumes or the average cube root of the particle mass over cell densities. We can see in this panel that there is a gentle increase of cell sizes with time, however, their values remain close to the initial conditions. Finally, in the bottom panel of Figure 8, we have calculated upper estimates for the ionisation time step using equation 14. The shaded box contains all of the 𝛿𝑡 values used for the simulations and this ﬁgure demonstrates that the criterion posed in equation 14 is always met. Using the results of Figure 8 we also propose using the Courant criterion as a conservative timestepping requirement: which establishes a direct relationship with the initial physical setup of each simulation. The timestepping criterion derived above ensures the convergence of the StarBench test as the particle mass is altered. In order for this RHD scheme to be reliably applied to more complex astronomical problems, however, we need to be able generalise the choice of time step beyond this simple test. The diﬃculty here arises from the fact that typically there are particle motions which are independent from the pressure-driven expansion of the H II region, and these particle motions can rapidly alter the volume of the ionised material. For example, a clump of dense gas can move at the periphery of the H II region, changing the local 3D geometry and causing a rapid ionisation of previously unavailable low-density gas, or alternatively, restricting radiative access to some parts of the H II region and thus shrink it. There is no analytic way of determining the size of the H II region in non-uniform medium (or else we would not need to perform the radiative transfer altogether), and hence we cannot determine the timestepping criterion precisely. Linking the ionisation time step to the Courant criterion (Courant et al. 1928), however, is probably a reasonable estimate. Ideally this should happen during the simulation runtime and the ionisation time step should be allowed to vary dynamically. Figure 7. The early-time expansion of an H II region, calculated using diﬀerent ionisation timesteps (‘SB II–VI’; see Table 2). The ﬁgure axes and the lines have the same meaning as in Figure 4. The lines demonstrate good convergence between the diﬀerent time steps that have been used. In order to study how the choice of Voronoi grid and type of density mapping aﬀect the H II region expansion, we have performed a set of simulations (‘SB VI’ – ‘SB X’; see Table 2) with 𝑁 = 64, 𝑚= 10Mand 𝛿𝑡 = 1.36×10Myr (the latter in compliance with the timestepping criterion from equation 17). Since only two of the three types of density mapping (‘Exact’ and ‘Centroid’) are compatible with both the basic and the regularised Voronoi grid, combining all grids and density mapping methods result in ﬁve simulations. Figure 9 shows a comparison between the ﬁve simulation runs. In the top panel of the ﬁgure we can see that all ﬁve expansion curves follow the theoretical solutions of Spitzer and Hosokawa-Inutsuka within 5% and 8% respectively. Furthermore, the individual curves of the simulations show only minor variation with respect to each other, and hence we have only plotted the residuals with respect to the theoretical solutions to emphasise these small variations. In the top panel of Figure 9 we can see that each type of density mapping produces D–type expansion, happening at a slightly diﬀerent rate (‘M/V’ happens most rapidly, followed by ‘Centroid’ and then ﬁnally by ‘Exact’). The choice between basic and regularised Voronoi grid, however, results in no diﬀerence in the expansion Figure 8. Top: velocity of the ionisation front as a function of time. The coloured lines use the analytic form of the ionisation front speed of the Spitzer (red; eq.15) and the Hosokawa–Inutsuka (blue; eq. 16) solutions, while the black line has been empirically calculated from ‘SB VI’. Middle: cell size immediately outside the ionisation front as a function of time. The solid line represents the average cube root of the cell volumes and the dash line is the average cube root of the particle mass over cell densities. Bottom: upper estimate of the allowed ionisation time step, using eq. 14. The solid and dashed lines have the same meaning as in the above panel. The grey shaded area contains all of the time steps used for the simulations. Figure 9. The early D-type expansion of an H II region, using diﬀerent combinations of Voronoi grids and density mapping methods (‘SB VI–X’; see Table 2). The plots show the relative error of the Phantom + CMacIonize solutions compared to the Spitzer (red) and Hosokawa-Inutsuka (blue) solutions, expressed as a percentage of the ionisation radius (top) and as a multiple of the local smoothing length (bottom). The solid lines represent simulations using a basic Voronoi grid, while the dotted lines use a Voronoi grid, which is regularised with Lloyd’s iterations. The diﬀerent shades of each colour correspond to diﬀerent density mapping methods. curve (compare the dotted lines with the solid lines of the same shade). This is not surprising, since these simulations start with a ‘glass’ distribution of particles, which in turn create regularly shaped Voronoi grid cells. It remains to be determined if the diﬀerences between the expansion curves, caused by the diﬀerent types of density mapping, are signiﬁcant. For this purpose, we have expressed the diﬀerence between the radius of the ionisation front of the simulation and that of the theoretical models in terms of the local smoothing length, ℎ (see the bottom panel of Figure 9). The smoothing length used in the ﬁgure is the average smoothing length of all particles with ionic fractions between 0.2 and 0.8 (which are the same particles used to determine the position of the ionisation front). In the bottom panel of the ﬁgure, we can see that all expansion curves are within ∼ 0.2ℎ of each other. This makes the diﬀerence between them sub–resolution, and hence we can deduce that neither the density mapping method, MNRAS 000, 1–22 (2021) SB XVII–XVIII 0.000125 1.41 × 1080781 80898 Table 3. Parameters of the simulations exploring the eﬀect of diﬀerent mass resolution. The last two columns contain the number of particles that are initially ionised. nor the choice of Voronoi grid have a signiﬁcant impact of the D–type expansion of an H II region in uniform medium. Next we study the eﬀects of resolution on the early–time StarBench test. We have achieved that by keeping the same initial gas density, and changing the particle mass, which naturally leads to variations in the smoothing length size (‘SB VI’, ‘SB VII’, ‘SB XI’ – ‘SB XVIII’; see Table 2). We have performed two simulation runs per resolution, one with basic and one with regularised Voronoi grid. The resolution in SPH is expressed in terms of particle mass, however, we report our results in terms of average initial smoothing length, since spatial resolution is more intuitive. The correspondence between mass resolution and spatial resolution is summarised in Table 3. Another implication of the varied resolution is that the initial Strömgren sphere is represented by a diﬀerent number of particles at each simulation setup (see Table 3). We have adopted ionisation time steps according to equation 17, which are a function Figure 10 summarises the results of the ﬁve diﬀerent spatial resolution tests. In it, ℎdenotes the average smoothing length of the SPH particles in the glass distribution of the original StarBench setup. The ﬁgure shows that using ℎ = 0.5ℎand ℎ = ℎproduces quite similar outcomes. However, as we pick larger smoothing lengths, the solutions start to diverge. In particular, ℎ = 4ℎ and ℎ = 8ℎno longer closely follow the Spitzer and HosokawaInutsuka solutions, and their H II region expansion happens more slowly than expected. Additionally, the choice of basic or regularised Voronoi grid does not signiﬁcantly alter the simulation outcome at any chosen resolution. Figure 11 presents the radial density proﬁle of the simulations at 𝑡 ≈ 0.02 Myr. In the ﬁgure we can see that the runs with larger smoothing lengths do not reproduce the expected thin shock (that is to say, a shock much thinner than the size of the ionised region). Since all of the theoretical solutions assume a thin shock, the numerical results naturally deviate from these solutions. Furthermore, the simulation with ℎ = 8ℎ, in particular, has a signiﬁcantly higher average density of the region internal to the shock, which additionally suppresses the radius of the ionised sphere. Finally, Figure 12 shows the mass of the ionised gas as a function of time for all of the resolution tests. The masses have been calculated by counting all of the particles with ionic fraction over 0.5 as fully ionised. This deﬁnition of the ionised mass gives us the exact amount of hot gas in the hydrodynamics, which has direct effect on the dynamics of the gas, and it is, arguably, the more relevant deﬁnition when we look at the time evolution of the H II region. An alternative approach would be to sum the ionic fractions multiplied Figure 10. The early D-type expansion of an H II region, using initial setup with diﬀerent spatial resolution (‘SB VI–VII’,‘SB XI–XVIII’; see Table 2). We express the resolution in terms of the smoothing length, where the default resolution is referred to as ℎ time. The Spitzer and Hosokawa-Inutsuka solutions are shown in dashed red and blue lines. The black lines represent the Phantom + CMacIonize radiation hydrodynamics scheme, with (dotted) and without (solid) using Lloyd’s algorithm. Bottom panels: the relative error of the Phantom + CMacIonize solutions compared to the Spitzer (red) and Hosokawa-Inutsuka (blue) solutions for simulations with and without Lloyd’s algorithm. Figure 11. Radial density proﬁle of the simulations presented in Figure 10 at 𝑡 ≈ 0.02 Myr (without using Lloyd’s iterations). The grey data points are individual gas particles (from left to right: ‘SB XVII’, ‘SB VI’, ‘SB XV’, ‘SB XIII’, ‘SB XI’). The Spitzer and Hosokawa-Inutsuka solutions are shown in dashed red and blue lines, and the black lines represent the Phantom + CMacIonize radiation hydrodynamics scheme. by the particle mass. This latter deﬁnition produces the amount of ionised gas, as calculated by the radiative transfer (for the density mapping methods that preserve mass). The ﬁgure demonstrates a clear progression between the diﬀerent simulations as the resolution is increased, and indicates a convergence towards a speciﬁc mass curve (see ℎ = ℎand ℎ = 0.5ℎ). We can also see that all runs overestimate the initial ionised mass (as they overestimate the Strömgren radius). This can be noticed most prominently with the lowest resolution simulations, which overshoot the mass by ∼ 100%. This very high initial mass subsequently decreases with time, suppressed by a very thick shock, until it begins to increase after about 0.02 Myr. The initial overestimate of ionised mass happens because the simulations with ℎ = 8ℎinitially ionise only about 40 particles, and hence have a substantial numerical error of the ionised mass. Bisbas et al. (2015) have expressed the mass of the H II gas from theoretical considerations, as: If we substitute the Spitzer (eq. 10) or the Hosokawa–Inutsuka solution (eq. 11) for 𝑅(𝑡), we ﬁnd that 𝑀∝ 𝑡. We have plotted the theoretically predicted ionised mass using the Spitzer solution in Figure 12 as a red dashed line. We have used the Spitzer solution and not that of Hosokawa–Inutsuka, because the former provides a better ﬁt to our simulations. We can see from the line that even though the dependence of the mass on the time is sublinear, for the small values of 𝑡 which we consider, the curve cannot be visibly distinguished from a straight line. Figure 12 shows that the Figure 12. Ionised mass as a function of time for the diﬀerent resolution tests (‘SB VI–VII’, ‘SB XI–XVIII’). The ionised mass is calculated by counting the SPH particles with ionic fractions over 0.5, and assuming that they are fully ionised. The solid lines represent the simulations with basic Voronoi grids, while the dotted lines show the simulations with regularised Voronoi grids. Note that the lines converge to a solution as the spatial resolution is increased. A theoretical prediction of the ionised mass as a function of time, based on the Spitzer solution, is shown in a red dashed line. slope of our simulations (and especially the higher resolution ones) follow the slope of the theoretical solution after a period of initial adjustment. This adjustment period is longer for the lower resolution simulations. In particular, for ℎ = 2ℎthis period is ≈ 0.017 Myr, for ℎ = 4ℎit is ≈ 0.033 Myr, and for ℎ = 8ℎthe slope is not reached at all within the ﬁrst ≈ 0.040 Myr of development. The agreement between the simulated and the theoretically predicted slope is expected, since the slope is set by the sound speed, the initial gas density and the Strömgren radius, which match between simulations and theory. Note that we do not expect the simulations to converge fully to the red line, as we do not expect them to converge fully (especially at very early times <0.007 Myr) to the Spitzer solution. Using the above results, we can estimate the resolution necessary for producing a converged initial size of the ionised region. If we assume that reproducing the Strömgren sphere radius within a few percent results in satisfactory accuracy, then we need to choose the resolution such that we have at least a few thousand initially ionised particles. Such resolution is suﬃcient for a uniform density simulation, however we cannot easily test if this estimate holds for simulations of clumpy medium. By contrast, if we want to accurately model the structure of the shock (provided that one exists) swept up by an H II region, we need to resolve the thickness of the shock. We can see in Figure 11 that even the lowest particle smoothing length which has been considered (corresponding to ∼ 8 × 10initially ionised particles) does not guarantee a converged shock proﬁle. We expand the parameter space exploration of the previous section, by now considering simulations of a single source in a clumpy medium (see simulations labelled as ‘B’ in Table 2). To recreate an astronomically realistic density structure, we have used a simulation MNRAS 000, 1–22 (2021) of the galactic centre cloud known as the Brick (Dale et al. 2019; Kruĳssen et al. 2019a). We have chosen a simulation snapshot corresponding to the present day location of the Brick along its orbit, and we have selected the particles contained in a 𝑅= 6 pc cube around the densest region. We have also shifted the origin of the coordinate system of the simulation to the centre of the cube for simplicity. This results in a setup with 𝑁 = 101128 particles, 𝑚= 0.4463 Mand a total mass of about 𝑀= 45000 M. The mean particle velocity has been subtracted from all individual particles’ velocities in order to remove the orbital motion of the cloud. All particles have an initial temperature 𝑇= 65 K, which was used by Dale et al. (2019) and Kruĳssen et al. (2019a), and is also consistent with the observed temperature of the Brick cloud (Ao et al. 2013; Ginsburg et al. 2016; Krieger et al. 2017). We have used one source of ionising radiation with¤𝑄 = 5 × 10s, which corresponds to a young stellar population with a mass of ∼ 10M(Leitherer et al. 2014). The source is located either in a density peak (𝑥 = 1.5 pc, 𝑦 = −0.5 pc, 𝑧 = −0.51 pc; local density 3.6 × 10g/cm), or in lower density environment (𝑥 = 0 pc, 𝑦 = 0.3 pc, 𝑧 = −0.51 pc; local density 1.8 × 10g/cm). The positions of the sources are marked in Figure 13 with stars. Similarly to the ﬁrst set of simulations, the source ionises a certain volume of gas which expands. In contrast to the ﬁrst set of simulations, the ionised volume is not spherically-symmetric. We have explored the expansion of the H II region using two diﬀerent positions of the source, as well as diﬀerent grid types and density mapping methods. Unlike in the previous section, we have not varied the ionisation time step or the resolution. The former choice has been made because we have already derived a timestepping criterion from the uniform density simulations (see eq. 17). The latter choice is due to the fact that the resolution of a clumpy medium could not be easily altered. Additionally, we vary the ionising luminosity of the source in the range¤𝑄 = 10− 10s, and calculate the corresponding initially ionised mass. Finally, we discuss the physical implications of the presence of an ionising source on the host cloud. We have used the Brick setup to perform ten diﬀerent simulations, which repeats the simulations labelled as ‘B‘ in Table 2 twice. For half of them the source is embedded in a clump, and for the other half the source is in a lower–density environment (see Figure 13). The ﬁve simulations per source probe the two diﬀerent Voronoi grids combined with the three diﬀerent density mapping methods. We have not altered the resolution of the simulations, as this is diﬃcult to achieve with non–uniform initial conditions. The non–uniform setup has also created diﬃculties in estimating the ionisation time step in advance. We have used the value of 𝛿𝑡 = 5 × 10Myr. In order to ensure the suitability of this choice, we have computed the righthand-side of equation 17 for each fully or partially ionised particle during runtime (using the particle’s density) and have conﬁrmed that these values were always larger than our time step. Figures 14 and 15 illustrate the expansion of the simulated ionised region with time, when we use the exact density mapping and a regularised Voronoi grid (‘B II’). We can see that when the radiation source is located in a dense clump, it initially ionises a small amount of high density gas. Through its expansion the ionised gas sweeps up a shock, similarly to the StarBench test. In contrast, the source located in lower density environment immediately ﬁlls up the inter–clump space with ionised material and its H II region undergoes gentle expansion. We can see the dynamic signatures of these two scenarios by looking at the gas density (left hand panels Figure 13. Selected cubic volume from a simulation snapshot of the Brick, used as initial conditions for the RHD scheme (Dale et al. 2019; Kruĳssen et al. 2019a). Left: gas column density integrated along the z-axis. Right: volume density of the gas in the plane of 𝑧 = −0.51 pc. The two stars mark the positions of the ionisation sources that have been used. Figure 14. Cross-section images at 𝑧 = −0.51 pc of volume density (left side) and speciﬁc internal energy (right side) of the Brick RHD simulation ‘B II’ (see Table 2) at diﬀerent times, shown on the panels. The source has been embedded in a dense clump and its location is marked with a star. of Figure 14 and 15). For clarity, we have also included the speciﬁc internal energy of the particles in the right hand panels of Figure 14 and 15. Since the ionised areas have signiﬁcantly higher speciﬁc internal energies than the neutral ones, the former appear in light blue and white. Additionally, if we look at the density peaks in Figures 14 and 15, we notice that they diﬀuse out with time. This behaviour is not caused by the ionisation, but it is a result of the physical assumptions in our simulations, and the way in which the initial conditions have been constructed. The Brick simulation from Dale et al. (2019) and Kruĳssen et al. (2019a) uses an external gravitational potential and self–gravity. In our setup we have turned oﬀ the gravitational forces and we have additionally set all particle velocities to zero. As a result, the density peaks have higher pressure than the surrounding low density regions, and no force to hold them together. This leads to the observed diﬀusion, which aﬀects (and likely serves to enable) the expansion of the H II region at later times. This does not hamper the numerical experiment performed here, in which we are exclusively interested in the impact of sub-structure, rather than the full, self-consistent evolution of the region. To quantify the expansion of the H II regions, we have computed the ionised mass as a function of time by adding up the masses of the particles with ionic fractions over 0.5 (see Figure 16). Despite representing two diﬀerent modes of H II region expansion (pressure-conﬁned and depressurised), the two panels of Figure 16 look very similar to each other. In both panels we see that the ionised mass increases approximately linearly for all simulation setups. This behaviour is also in agreement with the StarBench results (see Figure 12). The diﬀerence between the top panel (high density source) and the bottom panel (low density source) of Figure 16 is mostly in the noise level of the curves and the magnitude of their slopes. The H II region embedded in a clump has noisier curves than the H II region in low density environment, which can be explained by the MNRAS 000, 1–22 (2021) clumpy structure of the high density environment (see Figure 14). Additionally, the expansion curves of the embedded H II region have shallower slopes than those of the low density H II region. This is expected as the embedded ionised gas needs to overcome the higher pressure of its surrounding material. While the choice of grid structure and density mapping prescription does not signiﬁcantly aﬀect the StarBench test, in the Brick simulations we see that the amount of ionised gas can vary greatly between the diﬀerent conﬁgurations. We examine these variations, both in terms of the time evolution of the H II region (see Figure 16), and in terms of the initial ionised mass. As already discussed in Section 4.1, the diﬀerent simulation setups produce qualitatively the same expansion of their respective H II regions (with some exception for ‘B III’ with the high density source). Furthermore, if we compare the ﬁve simulations with the low density source, we see that the ionised mass curves appear to be systematically oﬀset from one another. The simulations with initially lower or higher ionised mass, continue to have lower or higher ionised mass at later times, relative to the other simulations. This may indicate that the diﬀerences between the time evolution of the simulations are primarily caused by diﬀerences in the initial ionised mass. Alternatively, the conditions which create the initial mass discrepancies (grid and density variations) may persist in time, and continuously maintain the discrepancies. Similar systematic behaviour is present in the simulations with an embedded source. However, since the expansion curves are noisier, there is no clear distinction between the results of ‘B I’, ‘B II’ and ‘B IV’. Overall the relative order of the expansion curves of the simulations with an embedded source is similar to that of the curves of the low density source, which favours the interpretation that the Figure 16. Ionised mass as a function of time for the Brick simulations (‘B I–V’; see Table 2) with embedded source (top) and the simulations with a source in a low-density environment (bottom). The solid lines represent runs using the basic Voronoi grid, while the dotted lines correspond to runs with regularised Voronoi grids. The diﬀerent colours show the type of density mapping used, with 𝜌(eq. 5) being black, 𝜌(eq. 2) being blue, and 𝜌 (eq. 1) being red. diﬀerent grid and density conﬁgurations maintain diﬀerences in the expansion continuously. We will now focus on comparing the individual simulations with one another. Let us ﬁrst consider the basic Voronoi grid and the regularised one with the same type of density mapping. Visually, the regularised grid resolves the low- and intermediate–density gas better (see Figure 17). Due to the regularisation, however, the grid cells become more evenly distributed and hence the density peaks are represented by fewer cells, causing them to be under–resolved. This means that an embedded ionising source may experience a smoothed density proﬁle in its surroundings, with lower peak densities. As a result this source initially ionises a larger region compared to if it was coupled with a basic Voronoi grid structure. In addition to the structure of the Voronoi grid, the type of density mapping also plays an important role in the outcome of the Brick simulations. The greatest outlier in Figure 16 is the curve, corresponding to the Centroid method, combined with the basic Voronoi grid (‘B III’). This simulation setup signiﬁcantly overpredicts the cell mass (by a factor of ∼ 3; see Appendix B), and it results in highly suppressed ionised mass, especially when the source is embedded in a clump. The inaccuracy of the Centroid Figure 17. Cross-section images of the starting time Voronoi grids at 𝑧 = −0.51 pc. The colour bar corresponds to the exact volume density, 𝜌(see equation 5), mapped onto a Voronoi grid built around the particles’ positions (top) and a regularised Voronoi grid (bottom). method is less pronounced when paired with a regularised grid (‘B IV’; only ∼ 9% higher than the total particle mass), due to the cell shapes. As a result, the behaviour of the simulation is similar to that with the exact density mapping (see the two dashed lines in Figure 16). Finally, the density mapping in which a particle mass is divided by the cell volume (‘M/V’; ‘B V’) agrees reasonably well (within a few tens of percent) with the ionised mass produced by the exact density mapping on a basic Voronoi grid (‘B I’). This can be attributed to the fact that while the local cell density may have inaccuracies, on larger scale the average density is correct, since the method conserves mass. The disagreement between the ﬁve diﬀerent simulations raises the question of which one gives the most accurate solution to the problem. Since we do not have an analytic solution in the general case of non-uniform density medium, we have attempted to answer this question numerically. We have applied CMacIonize to a high-resolution Cartesian grid without performing any subsequent hydrodynamics calculations due to high computational cost. The density mapping has been performed using the Centroid method (eq. 2). Since the method does not necessarily conserve mass, as previously discussed, the resolution of the Cartesian grid has been gradually increased until both the total mass of the medium and the ionised mass had converged. The convergence is achieved for a grid with 1024cells. Note that the cell size of this Cartesian Figure 18. Cross-section images of the initially ionised grid cells at 𝑧 = −0.51 pc with¤𝑄 = 5 × 10sand a source positioned at low density environment within the Brick. The colours correspond to the density of the ionised gas only. The diﬀerent panels correspond to the ﬁve diﬀerent simulations described in Section 4, with an additional reference run. The reference simulation has been performed on a high-resolution (1024) Cartesian grid. For comparison, each Voronoi grid consists of 101128 cells. grid is 0.006 pc, while the smallest smoothing length in the Brick simulation is 0.014 pc, which allows the grid to capture features that might not be resolved in the hydrodynamics. A comparison of the initial ionised gas density between the ﬁve simulations together with the Cartesian grid is shown in Figure 18. The ﬁgure contains a density slice at 𝑧 = −0.51 pc, and the source has been positioned in the lower density location (𝑥 = 0 pc, 𝑦 = 0.3 pc, 𝑧 = −0.51 pc). We can see that the simulations with regularised Voronoi grids are in better agreement with the Cartesian grid (labelled as ‘Reference’). Furthermore, if we compare the simulations with basic Voronoi grid, we can see that the ‘Exact’ and ‘M/V’ runs agree quite well with each other, and are still relatively similar to the Cartesian grid result, while the ‘Centroid’ run diﬀers the most from all the others. Note that the ‘Reference’ image contains a white region in the middle of the ionised volume. This does not indicate a clump of neutral gas, but it is instead a region, which is completely empty of gas (ionised or neutral). MNRAS 000, 1–22 (2021) Table 4. Initial ionised mass in the Brick simulations. The ionised mass is calculated by multiplying the ionic fraction of a particle by the particle’s mass and summing over all particles. The reference value is obtained by performing the radiative transfer on a high-resolution (1024) Cartesian grid. Additionally, we have calculated the total ionised mass (including contributions from the partially ionised cells) obtained with the Cartesian grid. In the case of the embedded source, the total ionised mass is 18.3 M, while in the case of the low–density source it is 340 M. Both of these values are lower than the numbers obtained by four of the ﬁve RHD simulation setups (see Table 4). In particular, the simulations using the exact density mapping and the two types of Voronoi grids, which are expected to produce the most accurate results, overestimate the ionised mass relative to the grid. The only setup which produces lower ionised mass is the ‘Centroid’ run, which overestimates the total mass due to lack of mass conservation, as discussed above. The disagreement between ionised mass computed on the Cartesian grid and that on the Voronoi grids likely originates from the limited resolution of the latter, and it will be discussed further in Section 4.3. Note that here we compare the total ionised mass as "seen" by the raditative transfer (i.e. the sum of ionic fraction times particle mass), as opposed to the initial ionised mass in Figure 16, where we have the total ionised mass as "seen" by the hydrodynamics (i.e. the total mass of all particles with ionic fraction over 0.5). This choice has been made for consistency with the Cartesian test. Finally, we also study the initial ionised mass (from the radiative transfer calculation) for diﬀerent values of the ionising luminosity,¤𝑄 (see Figure 19). This is achieved by performing individual MCRT runs without evolving the cloud in time. Figure 19 demonstrates that as we increase¤𝑄, the initial ionised mass also increases, as expected. Note that the red data points represent the results of the Cartesian grid tests, mentioned above (and shown in Table 4). We also see that the diﬀerent simulation setups produce curves that do not cross each other as¤𝑄 is varied. This demonstrates that there are systematic diﬀerences, resulting from the choice of grid and density mapping. The order of the curves (from higher to lower mass) in the two panels of Figure 19 diﬀers between the embedded and the low density source, which emphasises the importance of the gas density distribution around the source. Despite the fact that we have not altered the resolution of the Brick setup, it is crucial to consider the resolution when discussing our radiation-hydrodynamics results. Since the H II region has an irregular shape, the most reliable measure of resolution is the number of initially ionised particles. For the simulations with an embedded source this number is under 50, while for the low density source ones it is under 1000. Compared to the uniform density tests, these simulations fall within the lower end of the resolutions that have Figure 19. Initial ionised mass as a function of ionising luminosity (¤𝑄) for the simulations with embedded source (top) and the simulations with a source in a low-density environment (bottom) within the Brick. The diﬀerent lines represent runs with diﬀerent Voronoi grids and types of density mapping, and have the same meaning as in Figure 16. The red symbols have been obtained using high resolution (1024) Cartesian grid. been considered (see Table 3). Therefore, from a numerical perspective, we expect that the expansion of the H II regions within the Brick is likely to be underpredicted. Note that in our lower resolution StarBench tests the initial ionisation radius and mass are typically overpredicted (see Figure 10 and 12), but despite that the expansion is slower than in the higher resolution runs. This may be caused by the time scale required for the formation of the shock, which is more prolonged at lower resolution. The overprediction of the initial ionised mass present in the low resolution StarBench test is consistent with overpredicted initial ionised mass in the Brick, when compared to the Cartesian reference test (see Table 4 and Figure 19). Indeed, the curves of the simulations with the exact density mapping (‘B I’ and ‘B II’; black lines), which we believe to be the most accurate estimate of the ionised mass, lie above the red data points in Figure 19. These results indicate a limitation of the RHD scheme, related to the fact that SPH is optimised for resolving ﬂuid elements of equal mass, whereas solving for the ionisation state of a diﬀuse medium requires high resolution at the ionisation front (this is illustrated by the outlines of the ionised regions in Figure 18). This limitation can be addressed either by improving the resolution of the grid structure, or by suﬃciently increasing the mass resolution in SPH. The ﬁrst approach can be achieved by inserting additional generating sites in the Voronoi grid via methods such as the one proposed by Koepferl et al. (2017), or by choosing a diﬀerent high-resolution grid structure altogether, such as a Cartesian grid or a grid constructed with an active mesh reﬁnement scheme. The increase of resolution can, however, signiﬁcantly increase the computational cost of the RHD scheme to the point where it becomes prohibitive. Additionally, increasing the resolution of the grid while keeping the number of SPH particles the same is unlikely to improve the time evolution of the ionised gas. Therefore, it is crucial that we select appropriately small SPH particle mass for the speciﬁc problem that we consider. In addition to using the Brick setup for numerical tests, our limited radiation-hydrodynamics simulation can already be used towards answering scientiﬁc questions. As mentioned in the introduction, we want to ﬁnd out (i) the ionised mass of a newly formed H II region and (ii) its rate of increase. The simulations of Dale et al. (2019) and Kruĳssen et al. (2019a) provide a natural starting point for answering these questions numerically, since they are currently the only existing models of the Brick capturing the eﬀects of the galactic gravitational potential on the structure of the cloud, and reproducing key observable properties, such as the aspect ratio, the column density, the line of sight velocity dispersion and the gradient of the line of sight velocity (Kruĳssen et al. 2019a). Our RHD runs of the Brick use a snapshot of one of these simulations as initial conditions. However, we have made crucial physical simpliﬁcations (such as using a sub-region of the cloud and omitting gravity ) for the purpose of our tests. Therefore, we will discuss the impact of these simpliﬁcations while addressing the above questions. The ﬁrst of the above questions can be directly answered from our results, and is not aﬀected by our choice of physical assumptions. The size/mass of a newly formed H II region depends solely on the luminosity and position of the source, as well as the density distribution of the gas. However, as discussed in Section 4.2, the density distribution of the gas is sensitive to the choice of grid type and density mapping method. Using Figure 19, we can conclude that the low density source initially ionises 340–600 M, while the embedded source ionises only 18–31 M, for an ionising luminosity of¤𝑄 = 5 × 10s. The ranges for these values have been obtained by considering the results of the Cartesian grid (the lower value of each range), and those of the simulations with exact density mapping (‘SB I’ and ‘SB II’). Even though the results of the Cartesian grid are more accurate due to its higher resolution at the ionisation front, it is useful to consider the full ranges, as they give estimates of the ionised mass uncertainty due to resolution limitations in the RHD simulations. Keeping these uncertainties in mind, we will be able to better estimate the ionised mass for other luminosities, where we do not have Cartesian results. The ionising luminosities that we have considered in Figure 19 are quite high for single sources (under the assumption of a wellsampled stellar initial mass function, they span stellar population masses of 2−20 × 10M, Leitherer et al. 2014). This choice has been made because of the embedded source, of which the H II region otherwise remains sub–grid. Even with these high values of¤𝑄, the embedded source typically ionises only a few SPH particles (with 𝑚= 0.4463 M). This is an indicator that a young, high-mass star in this simulated cloud would likely have a very compact and trapped H II region. Therefore, it appears that only a star which has accreted its natal clump or has been expelled from its birth environment to a low gas density location can substantially ionise the cloud. This result is consistent with the ﬁndings of (Sartorio et al. 2021), who studied single-source ionisation in a turbulent box, and found that placing the source next to a ﬁlament produced a small H II region and only had a minor impact on the gas dynamics. A possible limitation of our simulations is the fact that, in practice, embedded stars accrete material through a disk, and the lower density environment above and below the disk can facilitate a larger H II region. Furthermore, earlier feedback in the form of stellar wind can carve out bipolar low density cavities, which subsequently become ionised (Kuiper & Hosokawa 2018). All of these considerations appear on size (and mass) scales much smaller than our particle resolution, and, hence, are not captured by our RHD simulations. However, while these sub-resolution considerations can aﬀect the initial size and shape of the H II region of the embedded source, our results provide at least an order of magnitude estimate of the initial ionised mass. Note that for the low density source, we do not expect any signiﬁcant H II region variation due to sub-grid geometry. The second question that we have posed (on how rapidly the mass of the H II region increases) is also answered by our RHD simulations. From Figure 16, we can measure that the expansion rate of the H II region in low density environment is ∼ 7 − 9 × 10Myr, while that of the embedded H II region is ∼ 1.6 − 1.9 × 10Myr. In this case, however, our assumed physical simpliﬁcations do aﬀect the results. The fact that we have neglected the eﬀects of gravity means that the denser structures cannot be held together and diﬀuse out over time (see Figures 14 and 15). As a result, more of the gas enters the outskirts of high-density regions and becomes ionised, implying that the time-evolution results in Figure 16 should represent upper limits on the H II region expansion. However, we can see in Figures 14 and 15 that the majority of the high density structures survive the H II region expansion and remain neutral, which suggests that the diﬀusion is likely to have a minor impact on the ionised mass, as the H II region is expanding in a lowdensity environment. Some uncertainty remains about whether or not the embedded source would be able to disperse its natal clump on the time-scale that we observe in our simulations when gravity is present and able to disrupt the H II region expansion. By contrast, from a numerical perspective, the measured H II region expansion is suppressed due to insuﬃcient spatial resolution (as discussed in Section 4.3), and thus represents a lower limit on the expansion. However, according to Figure 12, this has an eﬀect on the size and mass of the H II region, but not on its rate of expansion, and hence it does not interfere with our measurement. Despite the uncertainty in the size of the H II regions, we see a physically plausible spatial distribution of the ionised gas. The H II region of the low density source evolves to ﬁll up the low density environment, with only minor destruction done on some of the clumpy structures. Similar behaviour has been observed by Dale & Bonnell (2011) and (Sartorio et al. 2021), who ﬁnd that ionising feedback can sometimes be ineﬃcient at carving out voids and the H II region would spread into pre-existing low density regions instead. In contrast, the embedded H II region manages to expand within its clump, but our limited setup does not allow us to determine if it would be able to destroy the cloud. An interesting additional question is whether or not the H II region expansion can trigger star formation. This question is more relevant for the embedded source, where the expansion of the ionised gas sweeps up a shock. Unfortunately, due to the lack of self-gravity, the pre-existing dense cores diﬀuse out, as previously discussed. As a result, the shock is not able to compress them beyond the tipping point of star (or sink) formation. Furthermore, the relatively low MNRAS 000, 1–22 (2021) resolution of the embedded H II region means that the shock is quite thick, and hence its density never reaches high enough values to trigger fragmentation via the collect-and-collapse mechanism. Therefore, the question of triggered star formation will be addressed in a further study. We have introduced a novel radiation-hydrodynamics scheme combining SPH and MCRT, and linking them via a Voronoi grid. We have demonstrated that our scheme can correctly model the hydrodynamics of an expanding H II region in uniform density environment. Furthermore, we have applied the RHD scheme to a clumpy cloud model of the Brick (Dale et al. 2019; Kruĳssen et al. 2019a), which is a dense and massive cloud in the CMZ of the Milky Way, thought to be the progenitor of a young massive cluster (Longmore et al. 2012). As part of our work, we have explored varying the ionisation time step, the SPH resolution, and we have used two diﬀerent kinds of Voronoi grid structure and three types of density mapping from the particles onto the grid cells. The results of these experiments allow us to formulate recommendations for future simulations, involving SPH, MCRT and Voronoi grids, which we include below. We recommend the use of a timestepping criterion, which we have derived in eq. 17. The criterion is similar to that of Courant et al. (1928) and other timestepping conditions that are otherwise employed in SPH codes (e.g. Price et al. 2018). The criterion can ensure convergence in non-dynamical initial conditions. However, additional care should be taken when running simulations with a signiﬁcant velocity dispersion. We have studied the eﬀects of varying the spatial resolution of the uniform-density simulations by increasing or decreasing the particle mass. We have found that lowering the resolution causes suppressed expansion of the H II region due to thicker shocks. Based on our results, we can deduce that we need at least a few thousand initially ionised particles in order to have a good model of D-type expansion in uniform medium. Based on our Brick simulations, we recommend that a similar criterion is also used in simulations in a clumpy medium. We have performed our simulations with two diﬀerent types of Voronoi grids and three diﬀerent types of density mapping (see Section 2). When comparing the basic to the regularised Voronoi grid, some preference should be given to the latter, as it represents the overall structure of the diﬀuse medium better. However, when we consider the simulation outcome, the better choice of Voronoi grid is situation dependent. Choosing one grid over the other makes no signiﬁcant diﬀerence to the expansion of the uniform density simulations. In the case of the Brick simulations, regularising the Voronoi grid improves the outcome when the source is in lowdensity environment and worsens it when the source is embedded, as the regularised grid underresolves density peaks. In terms of the density mapping method, we always recommend using the exact density mapping (see eq. 5), when the computing time is not an issue. If it is not possible to use the exact mapping, the choice between dividing the particle mass by the cell volume (eq. 1), or using the centroid method (eq. 2) depends on the choice of Voronoi grid. In the Brick simulations, we ﬁnd that using the former approximate density mapping method gives similar results to the exact mapping on the basic Voronoi grid. By contrast, the centroid method produces a similar outcome to the exact mapping on the regularised Voronoi grid. Note that all types of density mapping result in very similar simulation results in uniform medium. In our simulations of the Brick with a source in a low-density environment we can see that the ionised material is preferentially located in pre-existing low-density regions. This does not have a strong eﬀect on the cloud morphology, and it is a phenomenon which has been seen in previous simulations. In contrast, our simulations of the Brick with a source embedded in a dense clump result in H II region expansion that sweeps up a shock. Our results also demonstrate that we need the ionising luminosity of a stellar population of several 10Min order to ionise material outside the clump of an embedded source, at the extreme gas densities observed in the CMZ. However, the necessary ionising luminosity may be overestimated due to insuﬃcient resolution. In particular, resolving the accretion disc of a young star, and/or including stellar winds, may accelerate the ionisation by allowing ionising photons to escape via low density bipolar cavities (Kuiper & Hosokawa 2018). The RHD scheme proposed in this paper contains a careful and accurate treatment of ionising radiation in combination with the large dynamical range advantages of SPH. As a result, it can be a useful tool for future studies of star formation and ionising feedback. Furthermore, the results presented here will serve as a guide for choosing time steps, resolution, type of Voronoi grid and density mapping for future simulations. MAP would like to thank Daniel Price and James Wurster for their technical assistance with Phantom, as well as Jim Dale for useful discussions. MAP and IAB acknowledge funding from the European Research Council for the FP7 ERC advanced grant project ECOGAL. MAP and JMDK gratefully acknowledge funding from the European Research Council (ERC) under the European Union’s Horizon 2020 research and innovation programme via the ERC Starting Grant MUSTANG (grant agreement number 714907). JMDK gratefully acknowledges funding from the German Research Foundation (DFG) in the form of an Emmy Noether Research Group (grant number KR4801/1-1). BV acknowledges partial funding from STFC grant ST/M001296/1 and currently receives ﬁnancial support from the Belgian Science Policy Oﬃce (BELSPO) through the PRODEX project "SPICA-SKIRT: A far-infrared photometry and polarimetry simulation toolbox in preparation of the SPICA mission" (C4000128500). Part of this work was performed using the DiRAC Data Intensive service at Leicester, operated by the University of Leicester IT Services, which forms part of the STFC DiRAC HPC Facility (www.dirac.ac.uk). The equipment was funded by BEIS capital funding via STFC capital grants ST/K000373/1 and ST/R002363/1 and STFC DiRAC Operations grant ST/R001014/1. DiRAC is part of the National e-Infrastructure. The SPH ﬁgures in this paper were created using SPLASH (Price 2007). The data underlying this article will be shared on reasonable request to the corresponding author.