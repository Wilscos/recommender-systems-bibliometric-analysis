When there are signiﬁcant service disruptions in public transit systems, passengers usually need guidance to ﬁnd alternative paths. This paper proposes a path recommendation model to mitigate the congestion during public transit disruptions. Passengers with diﬀerent origin-destination and departure times are recommended with diﬀerent paths such that the system travel time is minimized. We model the path recommendation as an optimal ﬂow problem with uncertain demand information. To tackle the non-analytical formulation of travel times due to left behind, we propose a simulation-based ﬁrst-order approximation to transform the original problem into linear programming. Uncertainties in demand are modeled with robust optimization to protect the path recommendation strategies against inaccurate estimates. A real-world rail disruption scenario in the Chicago Transit Authority (CTA) system is used as a case study. Results show that even without considering uncertainty, the nominal model can reduce the system travel time by 9.1% (compared to the status quo), and outperforms the benchmark capacity-based path recommendation. The average travel time of passengers in the incident line (i.e., passengers receiving recommendations) is reduced more (-20.6% compared to the status quo). After incorporating the demand uncertainty, the robust model can further reduce the system travel time. The best robust model can decrease the average travel time of incident-line passengers by 2.91% compared to the nominal model. Keywords: Path recommendation; Robust optimization; Rail disruptions; Demand uncertainty 1.1. Background continuous expansion, and near-capacity operations, service disruptions often occur. These incidents may result in delays, cancellation of trips, and economic losses (Cox et al., 2011). (or line/route) is interrupted for a relatively long period of time (e.g., 1 hour). During a disruption, aﬀected passengers need to ﬁnd an alternative path or use other travel modes (such as transfer to another bus route). However, due to a lack of knowledge of the system (especially during incident time), the new routes chosen by passengers may not be optimal or even cause more congestion (Mo et al., 2022). For example, during a Public transit (PT) systems play an important role in urban mobility. However, with aging systems, This study considers signiﬁcant service disruptions in public transit systems where the incident service rail disruption, most of the passengers may choose some bus routes that are parallel to the interrupted rail line as an alternative. However, given the limited capacity of buses, the parallel bus line may be over-saturated and passengers have to wait for a long time to board due to being denied boarding (or left behind). 1.2. Objectives and Challenges ﬂows are re-distributed in a better way and the system travel times are reduced. This can be seen as solving an optimal passenger ﬂow distribution problem over a public transit network. However, there are several challenges to this problem. disruptions and protect the recommendation results against uncertainties due to inaccurate demand estimates. Diﬀerent from previous recommendation systems that focus on maximizing individual preference, this study targets a system objective by minimizing the total travel time of all passengers (including those who are not in the incident line/area). To address the aforementioned ﬁrst challenge, we propose a simulationbased linearization to convert the total system travel time to a linear function of path ﬂows using ﬁrst-order approximation, which provides a tractable optimization problem. For the second challenge, this study focuses on the demand uncertainty (i.e., how many passengers will use the PT system during a service disruption) and models it with the robust optimization (RO) technique. The proposed approach is implemented in the Chicago Transit Authority (CTA) system with a real-world urban rail disruption as the case study. One of the strategies to better guide passengers is to provide path recommendations so that the passenger • First, as the objective is to reduce the system travel time, we need to have an analytical formulation to calculate passengers’ travel time of a path. However, passengers’ waiting time at the boarding and transfer station is not only determined by other waiting passengers, but only those who already boarded the same line as they reduce the vehicle’s capacity (De Cea and Fernández, 1993). This complicated interaction makes it diﬃcult to have an analytical formulation for passenger’s travel time when the left behind is not negligible (which is usually the case during service disruptions). More details on this challenge are elaborated in Section 2.3. • Second, there are many uncertainties in the system, such as the number of passengers using the PT system during incidents (i.e., demand uncertainty), incident duration, and whether passengers would follow the recommendations or not (i.e., behavior uncertainty). None of the previous studies have considered uncertainties in modeling an optimal passenger ﬂow problem. This study aims to propose a path recommendation model to reduce the crowding during public transit The main contributions of this paper are as follows: • To tackle the non-analytical system travel time calculation, we propose a simulation-based linearization to convert the total system travel time to a linear function of path ﬂows using ﬁrst-order approximation. Importantly, we utilize the physical interaction between passengers and vehicles in a public transit system to eﬃciently calculate the gradient (i.e., marginal change of travel time) without running the simulation multiple times (as opposed to traditional black-box optimization). • We use robust optimization to model the demand uncertainty which protects the model against inaccurate demand estimation. Speciﬁcally, we derive the closed-form robust counterpart with respect to the intersection of one ellipsoidal and three polyhedral uncertainty sets. These uncertainties capture the demand variations and the potential demand reduction during an incident. We also provide a feasible way of combining historical and survey data to quantify the uncertainty parameters. 3, we describe the problem and discuss the solution methods. We apply the proposed framework on the CTA system as a case study in Section 5. The model results are analyzed in Section 6. Finally, we conclude our study, summarize our main ﬁndings in Section 7. That is, the main objective is to ﬁnd available routes or the shortest path given an OD pair when the network is interrupted by incidents. For example, Bruglieri et al. (2015) designed a trip planner to ﬁnd the fastest path in the public transit network during service disruptions based on real-time mobility information. Böhmová et al. (2013) developed a routing algorithm in urban public transportation to ﬁnd reliable journeys that are robust for system delays. Roelofsen et al. (2018) provided a framework for generating and assessing alternative routes in case of disruptions in urban public transport systems. To the best of the authors’ knowledge, none of the previous studies have considered path recommendations at the system level, that is, providing path recommendations for passengers at diﬀerent OD pairs and with diﬀerent departure times so that the system travel time is reduced. 2.2. Passenger evacuation under emergency emergencies. The objective of evacuation is usually to minimize the total evacuation time. In general, these evacuation papers can be categorized into micro-level and macro-level based on how passenger ﬂows are modeled and the range of study areas. strategies within some infrastructure. For example, Wang et al. (2013) simulated the passenger evacuation under ﬁre emergency in Metro stations. Chen et al. (2017) implemented four methodologies including a queuing model and an agent-based simulation to calculate the evacuation time under a given number of evacuees in diﬀerent emergency situations and evacuation plans. Hassannayebi et al. (2020) used an agentbased and discrete-event simulation model to assess the service level performance and crowdedness in a metro station under various disruption scenarios, including train failure in the tunnel and ﬁre at the station gallery. Zhou et al. (2019) proposed a hybrid bi-level model to optimize the number and initial locations of leaders as well as the routes of leaders during the evacuation to guide passenger’s evacuation in urban rail transit stations. from the incident location through various transportation modes. For example, Abdelgawad and Abdulhai (2012) developed an evacuation model with routing and scheduling of subway and bus transit to alleviate congestion pressure during the evacuation of busy urban areas. Wang et al. (2019a) proposed an optimal bus bridging design method under operational disruptions on a single metro line. Tan et al. (2020) proposes an evacuation model with urban bus networks as alternatives in the case of common metro service disruptions by jointly designing the bus lines and frequencies. diﬀerences. First, in our paper, the service disruption is not as severe as the emergency situation. The service will recover after a period of time and passengers are allowed to wait. They do not necessarily need to cancel The remainder of this paper is organized as follows. Literature review is shown in Section 2. In Section Most previous studies on path recommendation under incidents focus on individual or a single OD level. Providing path recommendations during disruptions is similar to the topic of passenger evacuation under The micro-level studies usually use an agent-based simulation model to evaluate diﬀerent evacuation The macro-level studies consider a larger study area (e.g., city-level) and aim to evacuate passengers The macro-level passenger evacuation is similar to the setup of this study, but with the following major trips or follow evacuation plans as assumed in evacuation papers. Second, in this study, we do not adjust the operation from the supply side. Instead, we focus on providing information to the passengers to better utilize the existing resources/capacities of the system. 2.3. Travel time calculation in public transit networks aﬀected by passenger ﬂows once passengers are onboard, thus is easy to model (e.g., modeled as a constant). But the waiting time is usually hard to calculate if the system is congested with left behind. works exist: frequency-based (static) and schedule-based (dynamic). In the frequency-based transit assignment model, the waiting time is either assumed to be reversely proportional to the (eﬀective) service frequency (Wu et al., 1994; Schmöcker et al., 2011; Nielsen, 2000), or modeled as a congestion function (e.g., BRP) of previously boarded ﬂows and new arrival ﬂows with exogenously-calibrated parameters (De Cea and Fernández, 1993). The former method does not consider the left behind, and the latter method only outputs a generalized waiting cost (rather than the waiting time as the vehicle capacity is not explicitly modeled) and requires a dedicated calibration process. Therefore, the frequency-based transit assignment model is not suitable for this study because congestion and left behind are not negligible during disruptions. Hamdouch et al., 2014; Schmöcker et al., 2008), the waiting time can only be obtained after a dynamic network loading (or simulation) process. For example, Schmöcker et al. (2008) used the fail-to-board probability to model the left behind behavior. This probability will be updated after ﬁnishing each network loading and can be used to calculate the waiting time. However, in this way, the waiting time is still a constant within each iteration. There is no direct way to formulate waiting time as a function of path ﬂows. distribution in transit networks has no closed-form formulation. This study proposes a simulation-based ﬁrst-order approximation to solve the original problem iteratively. And given a tractable linear programming model, the uncertainties can also be incorporated. 2.4. Robust optimization is to specify a range for an uncertain parameter (the “uncertainty set”), and optimize over the worst-case realizations within the bounded uncertainty set. The method is therefore well suited to applications where there is considerable uncertainty related to the model input parameters, and when data uncertainties can lead to signiﬁcant penalties or infeasibility in practice. The solution method for robust optimization problems involves generating a deterministic equivalent, called the robust counterpart. Computational tractability of the robust counterpart has been a major practical diﬃculty (Ben-Tal et al., 2009). A variety of uncertainty sets have been identiﬁed for which the robust counterpart to a robust optimization problem is reasonably tractable (Bertsimas et al., 2011). (Ben-Tal and Nemirovski, 1998, 1999) and early 2000s (Bertsimas and Sim, 2004) established the ﬁeld. Comprehensive surveys on the early literature were done by Ben-Tal et al. (2009) and Bertsimas et al. (2011). The development of the robust optimization technique has allowed researchers to tackle problems with data uncertainty in a range of ﬁelds. Examples can be found for renewable energy network design (Xiong et al., Passengers’ travel time has two components: in-vehicle time and waiting time. In-vehicle time is not Passengers’ travel time is usually modeled in the transit assignment literature, where two major frame- In terms of the schedule-based models (Nguyen et al., 2001; Hamdouch and Lawphongpanich, 2008; As formulating travel time as a function of path ﬂows remains a challenge, the optimal passenger ﬂow RO is a common approach to handle data uncertainty in optimization problems. The general approach The RO ﬁeld has grown substantially over the past two decades. Seminal papers in the late 1990s 2016), supply chain operations (Ma et al., 2018), health care logistics (Wang et al., 2019b), and ride-hailing (Guo et al., 2021). techniques into path recommendations during service disruptions. This research gap is important to address given the potential inaccurate estimates of demand in public transit networks during an incident. 3.1. Problem description disruption, some stations in the incident line (or the whole line) are blocked. Passengers in the blocked trains are usually oﬄoaded to the nearest platforms. To respond to the incident, some operation changes are made, such as dispatching shuttle buses, rerouting existing services, short-turning in the incident line, headway adjustment, etc. Assume that we have all information about the operation changes. These changes deﬁne a new PT service network and available path sets. Our objective is to design an origin-destination (OD) based recommendation system. That is, when the incident happens, passengers can use their phones, websites, or electrical boards at stations to access the system, inputting their origin, destination, and departure time to get a recommended path. And the recommendation aims to minimize the system travel time, that is, the sum of all passengers’ travel time, including passengers in nearby lines or bus routes without incidents (note that these passengers may experience additional crowding due to transfer passengers from the incident line). on whether passengers with the OD are aﬀected by the incident or not. Note that as the path recommendation starts at T blocked vehicles) is their current location (as opposed to their initial origin such as the boarding station). We aim to provide recommendations for passengers whose OD pair in K and departure time in the range from T Tmay also need guidance. We divide the periods of recommendation into a time point (h equal-length time intervals (h at T represents the time interval (T Recommendations at h happens and their departure times are in (T be H := {h includes all feasible services that are provided by the PT operator. A path r ∈ R system to recover (i.e., using the incident line), or transfer to nearby bus lines, using shuttle services, etc. We do not consider non-PT modes such as Uber or driving for the following reasons: 1) This study aims to design a path recommendation system used by PT operators. The major audience should be all PT users. Considering non-PT modes needs the supply information of all other travel modes and even consider non-PT users (such as the impact of traﬃc congestion on drivers), which is beyond the scope of this study. Future research may consider a multi-modal path recommendation system. 2) Passengers using non-PT modes can be simply treated as demand reduction for the PT system. So their impact on the PT system is still captured. h ∈ H. It can be treated as the normal demand minus the number of passengers leaving the PT system. As However, to the best of the authors’ knowledge, no existing papers have incorporated robust optimization Consider a service disruption in an urban rail system starting at time Tand ending at T. During the Let K be the predetermined set of all OD pairs that may need path recommendation. K is deﬁned based , the origin for passengers who are already in the system (e.g., oﬄoaded passengers from the to some time after T, because the congestion may last longer than T, passengers depart after focus on passengers who are already in the system (and their departure times are T). And h(t ≥ 1) Given the new operation after T, we can obtain a feasible path set Rfor each OD pair k. Note that R Let dbe the number of passengers using the PT system with OD pair k ∈ K and departure time we do not have full information about future demand and number of passengers leaving the system, d uncertainty variable which will be discussed in Section 3.4. Let f at time interval h, with OD pair k, and using path r ∈ R Let p convenience of description, we deﬁne F := {(h, k, r) : ∀h ∈ H, ∀k ∈ K, r ∈ R indices. Then the optimal ﬂow problem can be formulated as: where f := (f expression. It can only be obtained after each network loading or simulation process (see Section 2.3). Note that using both of f and p in the optimization problem is redundant, but it is useful for the methodology explanation. recommendation proportion. That is, for all passengers who input OD pair k and departure time h, the system will recommend them to use path r with probability p We cannot solve it directly because Z(f ) has no analytical expression. Moreover, given the uncertainties in demand, the ﬁnal recommended path shares may not be p to solve the robust “optimal ﬂow problem” with demand uncertainties. 3.2. Event-based public transit simulator 3.2.1. Simulator design simulator used in this study (Mo et al., 2020). It can be used to evaluate Z(f ) and facilitate simulation-based linearization. OD demand (or smart card data), path shares, network structure, and train movement data (or timetable). Three objects are deﬁned: trains, queues, and passengers. Trains are characterized by routes, runs, current locations, and capacities. Passengers are queued based on their arrival times. Three diﬀerent types of passengers are represented: left-behind passengers who were denied boarding from previous trains, new tap-in passengers from outside the system, and new transfer passengers from other lines. The left-behind passengers are usually at the head of the queue. events are considered: train arrivals and train departures. The events are sorted by time and processed be the corresponding path share of f(i.e., p= f/dandp= 1). For the If there was no uncertainty in the system, the optimal path shares (p) solved from Eq. 2 are the Before introducing the solution procedure for Eq. 2, we ﬁrst describe an event-based public transit Figure 1 summarizes the main structure of the simulator. The inputs for the simulator are time-dependent An event-based modeling framework is used to load the passengers onto the network. Two types of sequentially until all events are successfully completed during the analysis period. Train event lists (arrivals and departures) are generated according to the actual train movement data or timetable. Each event contains a train ID, occurrence time, and location (platform). Passengers are assigned to a path based on the corresponding input path shares. Note that in this study, a “path” is deﬁned with speciﬁc boarding and transfer stations and lines. Two journeys that share a common line can be treated as two diﬀerent paths. Hence, there is no “common line” problem (De Cea and Fernández, 1993) in this study. the station and updates its state (e.g. train load and in-vehicle passengers). For passengers who reach their destinations, their tap-out times are calculated by adding their egress time. For those who transfer at the station, their arrival times at the next platform are calculated based on the transfer time. The transfer passengers are added to the waiting queue in order of their arrival times at the next platform. who arrive at the platform after the last train departed are added into the queue based on their arrival times. Passengers board the train according to a First-Come-First-Serve (FCFS) discipline until the train reaches its capacity. Passengers who cannot board are left behind and wait in the queue for the next train. The states of the train and the waiting queue are updated accordingly. time, platform arrival time, boarding time, alighting time, tap-out time, etc. This information can be used for the simulation-based linearization of the objective function Z(f ). 3.2.2. Simulating service disruptions side. Speciﬁcally, all incidents’ impacts can be reﬂected by changes in vehicles’ arrival and departure times. For example, the blockage of a rail line can be seen as some vehicles in the line having long dwelling time at the corresponding stations during the incident period. The dispatching of shuttle buses can be seen as adding a new set of events (vehicle arrivals and departures) associated with the new bridging route. The headway adjustment of existing routes can also be captured by the new vehicle arrival and departure times. In this way, the event-based simulator can conveniently model the service disruption without changing the For an arrival event, the train oﬄoads passengers who reach their destination or need to transfer at For departure events, the queue on the platform is updated by the new tap-in passengers, that is, passengers The simulator can record every passenger’s trajectory during the whole travel process, including tap-in Given a service disruption, the event list is modiﬁed to incorporate the incident’s impact on the supply framework. the nearest platform. Depending on the input path choices (i.e., recommendation strategies) p, oﬄoading passengers are re-assigned to a new alternative path and join the queues at the corresponding boarding station. After reassigning the oﬄoading passengers, the simulator continues to run from the incident to the end of the simulation period (note that passengers who have not entered the system when the incident occurs will have a new path choice depending on the input p). 3.3. Simulation-based linearization of the objective function ﬁrst-order approximation. Notice that Z(f ) can be approximated as: where Z(˜f) is the system travel time estimated by simulation with gradient vector of Z(f ). As that be approximated as: where e represents the numerical approximation of the gradient. Then we only need to calculate Z( One of the naive methods is to run a simulation with is time-consuming, this method is not eﬃcient. Since we already run a simulation for directly calculate the marginal change without running it again. Given the deﬁnition of the gradient, the problem is to calculate the additional travel time increase to the system if one additional ﬂow is added to of station a duplicated in Figure 2). First of all, the system travel time is increased by T ﬂow amount. be aﬀected. Passengers at station a waiting time if the vehicle that M the increase of one ﬂow in have to board the next bus (i.e., wait for one more headway). Mathematically, let V that M board in one of the vehicles in V From the passenger side, when an incident happens, all passengers in the blocked trains are oﬄoaded to In this section, we propose a simulation-based linearization for the non-analytical Z(f ) based on the ˆZ(f) is the ﬁrst-order approximation of Z(f).˜f is a reference ﬂow for the ﬁrst-order approximation. |represents the change of system travel time caused by one unit of ﬂow change in f, it can Consider an example journey of˜fin Figure 2. Let Mbe the set of passengers that counts the ﬂow (i.e., the orange passengers in Figure 2). These passengers have origin of station aand destination as T(˜f). Suppose that we want to add one more passenger to˜f(i.e., the orange passenger is Besides, it may also aﬀect other passengers’ travel time. All passengers in the red-dashed square may board at station b, adding an additional passenger to Mmeans we have one more passenger departure from station b, then the total increase in system travel time for passengers queuing behind M where B of vehicle v at station b. The sum over all vehicles is because we do not specify the exact vehicle that the additional passenger will board, and thus take the average over all vehicles. In this example, since there are two boarding stations for M vehicles are full. a), adding one ﬂow to And the queuing passengers at the on-board stations may not be able to board due to the reduction of capacity. Speciﬁcally, if a vehicle is full when it departs from an onboard station under ﬂow pattern And the system travel time is increased by one headway for each of these onboard stations. Mathematically, let O 1, O calculate the increase in system travel time due to adding one ﬂow to again. These increases come from three parts: 1) the average travel time of M amount, 2) the additional waiting time for passengers queuing behind M For passengers waiting at stations where Mare on-board (referred to as on-board stations, e.g., station makes one passenger waiting at the on-board station unable to board his/her original boarded vehicle. be the set of all on-board stations for Mand vehicle v ∈ V. For example, for vehicles in Line will be a, a, and a. Then the travel time increase for passengers waiting at on-board stations is: Therefore, in this way, depending on whether the vehicle is full or not under ﬂow pattern˜f, we can time for passengers queuing at M function becomes: where β( addressing uncertainties in the optimization problem. 3.4. Demand uncertainty across diﬀerent days, and the second is the uncertainty in how many passengers leave the PT system during the incident. In this section, these two parts of uncertainties are considered as a whole by introducing an ellipsoidal uncertainty set and three polyhedral uncertainty sets. 8 as: Note that β ﬂow problem as: And Eq. 11 can be written as a matrix form: where a ∈ R Deﬁne d = (d Proposition 1. If d is normally distributed with d ∼ N ( guaranteed to be satisﬁed with probability of at least 1 − ε (i.e., P[a Consequently,|can be obtained from Eq. 4. Deﬁne β(˜f) :=|. Then the objective ˜f) = (β)and β=|. Eq. 8 is a linear function of f , which supports for The uncertainty of dcomes from two diﬀerent parts. The ﬁrst is the inherent demand variations From the constraint 2c, we can substitute f= d· pto the objective function and rewriting Eq. To model the uncertainty of d, we introduce an auxiliary decision variable t and rewrite the optimal can be formulated as: where A ∈ R (i.e., d = (1 − ε)-percentile of a standard normal distribution. If we want constraint 12 to hold with probability at least 1 − ε, it suﬃces to have: (Bertsimas and den Hertog, 2020): Therefore, Eq. 16 can be rewritten with the convex conjugate: which ﬁnishes the proof of Step 2. Combining step 1 and 2 ﬁnishes the proof of the whole proposition. being large in directions with considerable uncertainty in the demand. Remark 1. In the RO, the ellipsoidal uncertainty set can be used no matter what distribution d follows. If d is normally distributed, the parameter ρ = 0. D is the Cholesky decomposition of Σ (i.e., Σ = DD). z is the perturbation variables ¯d + Dz) and Z=z ∈ R: kzk≤ ρ(i.e., the ellipsoidal uncertainty set). ρis the Since d is normally distributed, we have a = Ad is normally distributed with a ∼ N (A¯d, AΣA). Step 2: We need to show that the robust counterpart of Eq. 13 is (A¯d)p + ρ(AD)p≤ b. Notice that Eq. 13 is equivalent to: Then the convex conjugate of δ(z | Z) (also known as the support function) can be derived as We observe that the ellipsoidal demand uncertainty performs like a regularization. It prevents p from probability for that constraint 12 holds. The use of multivariate normality assumption in Proposition 1 is for explaining the physical meaning of ellipsoidal uncertainty set and facilitating the choice of hyperparameters (i.e., ρ of d using smart card data. The Mardia’s Skewness Test (Cain et al., 2017) shows that d has no signiﬁcant skewness. intervals and OD pairs. However, it does not impose any upper or lower bounds to d demand level for a speciﬁc OD pair and time interval is usually bounded, which can be expressed as: where d obtained from historical demand data. Eq. 20 can be rewritten in a vector form as d We can rewritten it as a “polyhedral uncertainty set”: Z uncertainty is that: within a given time interval, the total demand across all OD pairs should also be bounded. This constraint can avoid some extreme scenarios that Eq. 20 cannot capture (e.g., all d or upper bounds). Mathematically: where d obtained from the historical demand. Deﬁne S ∈ R otherwise S where d set: Z travel time, intuitively, the worst-case scenario will be the largest demand in the uncertainty set. This may make the worst-case demand unreal as the extremely large demand seldom happens. What we expect in the RO is that the model can capture some critical OD pairs where the high demand in these OD pairs can make the system more congested (as opposed to high demand in all OD pairs). In order to let the RO captures critical OD pairs, we add an additional constraint on the total demand: where Γ > 0 is a predetermined constant. Γ = 1 means we assume the total demand in the worst case scenario is the same as the nominal one, but the spatial and temporal distributions are diﬀerent, and the worst and D). Moreover, in the case study, we partially validate the multivariate normality assumption Eq. 13 (i.e., the ellipsoidal uncertainty set) captures the correlation between demands at diﬀerent time and dare the corresponding lower and upper bounds for d, respectively. Their values can be )and d= (d). Since we have d =¯d + Dz, a simple manipulation leads to Eq. 20 ensures the boundaries for each individual demand. Another similar constraint for the demand and dare the lower and upper bounds for the total demand in time interval h, which can be = (d)and d= (d). And Eq. 23 can also be represented as a polyhedral uncertainty =z ∈ R: d− S¯d ≤ SDz ≤ d− S¯d. As the RO aims to optimize under the “worst case” scenario and our objective function is the system case scenario will have more demand on critical OD pairs but less demand on others. The value of Γ can be decided by the historical highest total demand or by empirical knowledge. where 1 ∈ R Lemma 1. For a constraintT ri(Z and the constraint becomes where δ Z) = ρ the support function for Z where the second equality follows from linear programming duality. Eq. 27 can be used to derive the support function for Z where y (i.e., 6 and 3) are used for the consistency in Eq. 29. Similarly, Eq. 24 can be written in a matrix form: =z ∈ R: 1(¯d + Dz) ≤ Γ · 1¯d. Therefore, the ﬁnal robust constraint for Eq. 12 is To derive the robust counterpart of the constraint, we ﬁrst introduce the following lemma. ) 6= ∅, and let Z = ∩Z. Then, (· | ·) is the support function (i.e., convex conjugate of the indicator function). The proof of Lemma 1 can be found in Ben-Tal et al. (2015). From Proposition 1, we have δ(y | ∈ Rand u∈ R are decision variables in the RO model. Note that the subscripts for y and u Eliminate t and put constraint 30b back to the objective function: ˆZ(p, u, v, y) which yields a second-order cone programming (SOCP). − Du= y(29c) (SD)v= y(29d) − (SD)v= y(29e) y= (AD) 3.5. Solution procedure can be formulated as: This SOCP can be eﬃciently solved by inner interior point methods that are embedded in many existing solvers. pattern is obtained. Hence, after obtaining p to update β used as the new Denote the solution for Eq. 33 as z β(˜f) and Z( where ﬁrst-order approximation as described in Section 3.3. The RC, WD, and Sim-FOA(·) problems need to be solved iteratively. This can be treated as a ﬁxed-point problem. A conventional way to solve a ﬁxed-point problem is the method of successive average (MSA). OD pair, the marginal costs of all paths for this OD pair are the same. This implies that, ideally, when the ﬂow distribution is optimal, we should have β assignment, the marginal cost (travel time) of every non-zero ﬂow path is the same (i.e., one cannot decrease the system travel time by switching passengers from one path to another). assignment context, the cost function is not continuous due to left behind. Adding one more passenger to a After incorporating the demand uncertainty, the ﬁnal robust counterpart (RC) of the optimal ﬂow problem However, due to the ﬁrst-order approximation of Z(f ), β(˜f) needs to be updated once a new ﬂow ˜f in Eq. 34 indicates˜f= d· p. And Sim-FOA(·) is a pseudo function of simulation plus In the typical optimal traﬃc assignment problem, the optimal ﬂow pattern is reached when for every = {r ∈ R| f= 0} is the path set with zero ﬂows. This implies that at the system optimal However, in our study, this cannot be set as the convergence criteria because, in the dynamic transit path may lead to the system travel time increasing by one or more headways. In fact, we have the following example showing that β never being satisﬁed. Example 1. Consider a single direction bus line with N stations (Figure 3) and a ﬁxed headway W . Assume every bus has a capacity of 1. And there is one passenger waiting at each station except for the ﬁrst station (i.e., there are N − 1 waiting passengers). Now suppose that we add one more passenger to station 1. Since the capacity of buses is 1, the newly added bus will force all waiting passengers to be left behind one more time. Hence, the total added system travel time is (N − 1) × W . In this scenario, the β with the new-added passenger can be arbitrarily large depending on the number of stations N. when the value of the system travel time is relatively stable within a range). Speciﬁcally, the MSA will converge if where Z( that when the current system travel time is close to its average value of the last T converges. Taking the average of the last T the discontinuity of the system travel time. 11 mean that we will use the path shares with the smallest system travel time over the last T world, the following system design can be used: Therefore, in this study, we deﬁne the convergence criteria based on the value of system travel time (i.e., ˜f)is the system travel time at t-th iteration and  is a predetermined threshold. Eq. 35 means The whole solution algorithm is described in Algorithm 1. Line 6 indicates the MSA step. Lines 10 and Let pbe the optimal path shares solved from Algorithm 1. To realize the optimal path shares in the real • Step 1: Transit operators deploy the recommendation system to smartphone apps, websites, and electrical screens at stations. • Step 2: Passengers, when using the system, need to input their origins, destinations, and departure times. • Step 3: For a passenger input OD pair k and departure time h, the system will return a single recommended path r to him/her with probability p. Algorithm 1 Solution procedure of the robust optimal ﬂow problem In this way, we may expect the ﬁnal path ﬂows are close to the system optimal path ﬂows if passengers follow the recommendation. 4.1. Solving the model with rolling horizon will be run at the beginning of an incident (h and after ([h including new demand estimates, new demand uncertainty sets, new available path sets, new service routes and frequencies, new incident duration estimates, etc. Based on the formulation above (i.e., let h solve the model to obtain recommendations for time [ strategies for current time incident and system operations can be used to help with better model performance (this is known as adaptive robust optimization). Note that optimal path shares with h > horizon manner. Then, when the time goes to 4.2. Incident duration uncertainty that we can only obtain a distribution of incident duration. In this section, we show that our formulation can be easily extended to capture the incident duration uncertainty with stochastic optimization (SO) techniques of 30, 40, or 50 minutes. For each scenario ξ ∈ Ω, we denote β gradient and current system travel time under ﬂow ˜f), β(˜f)= Sim-FOA(d, p) = arg minZ(˜f) The current model development is a one-shot solution for path recommendation, which means the model Speciﬁcally, at time interval˜h, we ﬁrst update the demand and supply information in the system, In this study, we assume operators have a reasonable estimate of incident duration. However, it is possible Let the set of all possible incident scenarios be Ω. For example, Ω may include incidents with duration for the RO problem becomes: E[ˆZ(p, u, v, y) where P(ξ) is the probability of scenario ξ happens. The expectation above is taking over diﬀerent incident scenarios. Deﬁne Z( them into, the objective function becomes As the constraints in the RO problem are not related to incident scenarios (i.e., β included in the constraint part), this implies that incorporating the incident duration uncertainty with SO only requires us to change the objective function. 5. Case study design urban rail system (Figure 4). The incident starts at 8:14 AM and ends at 9:13 AM on Feb 1st, 2019 due to infrastructures issues between Harlem and Jeﬀerson Park stations. And the whole blue line is suspended. During the disruption, the destination for most of the passengers is the “Loop”, which is the CBD area in Chicago. Usually, there are four paths leading to the Loop: 1) using blue line (i.e., waiting for the system to recovery), 2) using the parallel bus lines, 3) using the North-South (NS) bus lines to transfer to the Green Line, and 4) using the West-East (WE) bus lines to transfer to Brown Line. Based on the service structure, we can construct the route sets R 5.1. Parameter setting as τ = 10 mins. The largest period with recommendation is h (i.e., 50 minutes after the end of the incident). In this study, we assume the incident duration is known or can be reasonably estimated. An alternative way to capture the incident duration uncertainty is stochastic optimization as discussed in Section 4.2. The factor of total demand level, Γ, is set as 1.1, which is the 90% percentile of the total demand distribution. Σ (which can be used to get D), and upper and lower bounds for demand (i.e., d can be estimated from historical demand. However as the demand on the incident day is smaller than usual given some passengers may leave the system, we cannot directly use normal day smart card data as historical demand. One possible solution is to ﬁnd previous days with similar incidents and use demand in those days In the case study, we consider an actual incident in the Blue line of the Chicago Transit Authority (CTA) K is set as all OD pairs with origins at the Blue line and destinations at the Loop. Time interval is set To quantify the demand uncertainty, we need to specify the nominal demand¯d, and covariance matrix as samples. But this is usually unavailable due to the lack of enough similar incidents. Hence, in this study, we ﬁrst use survey results and historical smart card data to generate “synthetic historical demand” samples, and then estimate the uncertainty set from the samples. diﬀerent days 2) and the uncertainty in how many passengers left the PT system during the incident. The ﬁrst part can be captured by historical smart card data (without incidents). And the second part is approximated by the survey results. According to previous survey-based studies, the proportion of the number of passengers leaving the PT system during incidents is around 10%∼30% (Lin et al., 2016; Rahimi et al., 2020). The “synthetic historical demand” is generated as follows: We collected a total of 16 work days from Jan 2019 (the previous month of the incident day) and generated 16 sample demand vectors. The mean value is used as the nominal demand are estimated from these samples. The upper and lower bounds for demand (i.e., d the samples’ maximum and minimum values, respectively. 0.84, 1.28, 1.64, 2.33}, which corresponds to {50, 60, 70, 80, 90, 95, 99} percentiles of the standard normal distribution. Note that ρ and it is applicable for the real-world incident. Therefore, even if using synthetic historical demand may introduce errors, as long as we show that this approach of uncertainty set deﬁnition yields reasonably good results, it is acceptable for real-world applications. Recall that the demand uncertainty comes from two parts: 1) the inherent demand variations across • Collect smart card data in a recent workday and calculate the demand vector without passengers leaving the system for each (h, k) (the demand for h = 0, i.e., oﬄoading passengers, can be obtained using the simulation model). • For each (h, k), randomly draw a proportion of leaving passengers from the uniform distribution U(0.1, 0.3). The demand after removing the leaving passengers is a sample demand vector. The hyperparameter ρfor the ellipsoidal uncertainty set are chosen from these values: {0, 0.25, 0.52, Note that the quantiﬁcation of demand uncertainty sets does not use any information on the incident day 5.3. Data description demand is 5,499, similar to the total actual demand (5,531), implying that introducing a proportion of leaving passengers (i.e., 10% - 30%) can capture the demand reduction in the incident day. We also observe that the aggregate nominal demand for each time interval is similar to that of the incident day. The major diﬀerences happen at the ﬁrst two time intervals (h = 0, 1). However, looking at the disaggregated demand for each (h, k), the diﬀerences are more prominent. The discrepancy between nominal and actual demands provides potentials for the RO to perform better. The Mardia test is used to check whether the samples’ multivariate skewness and kurtosis are consistent with a multivariate normal distribution. If both are satisﬁed, we can assume the samples are multivariate normally distributed. We observe that, in Table 1, the synthetic historical demands have consistent skewness but inconsistent kurtosis with the multivariate normal distribution, suggesting that they are not multivariate normally distributed. However, as skewness is a measure of the asymmetry of the probability distribution of a random variable about its mean, Mardia Skewness testing shows the demand distribution is symmetric. Hence, it is still reasonable to use the ellipsoidal uncertainty set to describe a symmetric distributed uncertain variable. Morever, as mentioned in Remark 1, the distribution of a variable does not aﬀect the deﬁnition of uncertainty set (it only aﬀects the calculation of probability guarantees). The nominal and actual (incident day) demands comparison are shown in Figure 5. The total nominal Table 1 shows the results of Mardia test of multivariate normality (Cain et al., 2017) for demand samples. 5.4. Benchmark models benchmarks. model corresponding to the intuition of “distributing passengers to diﬀerent paths” when no information is available. paths according to the path capacity. Speciﬁcally, for a path in OD pair k and time h, we calculate the path capacity as the total available capacity of all vehicles passing through the ﬁrst boarding station of the path. For example, for a path consisting of an NS bus route and the Green Line, the path capacity is calculated as the total available capacity of all buses at the boarding station of the NS bus route during time interval h. The available capacity can be obtained from the simulation model using historical demand. The available capacity for the Blue line (i.e., incident line) depends on new operation schedules on the incident day (i.e., the service suspension is considered). When no vehicles operate in the Blue line, the path capacity will be zero. incident day. Since all passengers using WE, NS and parallel bus lines need to tap in, the demand increases (i.e., the number of incident day tap-ins minus the mean number of normal days tap-ins) in these lines can be seen as the number of passengers choosing the corresponding path. Hence, by identifying the demand increase for all nearby bus stops, we can get the number of passengers using the parallel bus, NS+Green, and WE+Brown paths for each OD pair k and time interval h. However, the number of waiting passengers in the Blue line is not directly recognizable because the CTA system does not record the tap-out information. Hence, we approximate the proportion of waiting passengers based on the survey results (Rahimi et al., 2019). Rahimi et al. (2019) used a survival model to analyze the waiting time tolerance of CTA riders during a service disruption. The model results provide the proportion of waiting passengers given diﬀerent system recovery times. Therefore, the status-quo path shares are inferred as follows: 6. Results optimization model without uncertainty (i.e., the nominal model with ρ shares. This shows the improvement obtained from the optimization-based path recommendation. And in the second step, we compare the robust model with the nominal model, which shows the improvement from considering uncertainties. To compare with the optimization-based path recommendations, the following path shares are used as Uniform path shares. The uniform path shares are deﬁned as p=∀ r ∈ R. This is a naive Capacity-based path shares. The capacity-based path shares aim to assign passengers to diﬀerent Status-quo path shares. The status-quo path shares are the inferred path choices of passengers on the • Step 1: Given the current time interval h and the incident end time T, obtain the remaining system recovery time if passengers choose to wait, based on which we can derive the proportion of waiting passengers using the results in (Rahimi et al., 2019). • Step 2: For each OD pair k and time interval h, get the number of passengers using the parallel bus, NS+Green, and WE+Brown paths based on demand increase. • Step 3: Fix the proportion of waiting passengers obtained from Step 1, other path shares are proportional to the number of passengers using the associated paths obtained in Step 2. In this section, we demonstrate the model’s performance in two steps. In the ﬁrst step, we compare the We observe that simulation-based linearization and MSA can successfully decrease the system travel time. And the model converges within 35 iterations. Note that the converged cost for the robust model is higher than the nominal model because the robust model is running with the worst-case demand (by deﬁnition with higher system travel time). The performance of all path recommendations will be evaluated on the actual demand (discussed in the next section). 6.2. Model evaluation demand is unknown when running the model (otherwise there are no uncertainties). After obtaining the path shares (either from optimization or the benchmark models), the recommendation strategies will be evaluated based on the actual incident day demand using the simulation model. The model can output the travel time of every passenger in the system. And it can be used to compare the performances of diﬀerent path shares. 6.3. Nominal model vs. Benchmark models passengers (a total of 27,007 passengers) and the passengers who originally want to use the Blue line (i.e., passengers who are provided with recommendations, a total of 5,531 passengers). Results show that the optimization-based path shares can outperform all benchmark models. For all passengers in the system, the average travel time is reduced by 9.1% compared to the status quo. And for incident-line passengers, the reduction is even higher (20.6%). passengers’ choices are not random and show some rationality. The capacity-based path shares can also signiﬁcantly reduce the system travel time (by 6.9%). However, as the capacity-based path recommendations do not reﬂect the boarding order of upstream and downstream stations, it is worse than the optimization-based results. optimization-based path shares have more evenly travel time across four types of paths, implying a better Figure 6 shows the convergence of the nominal model (ρ= 0) and a robust model (ρ= 0.84). The optimization model only utilizes the information of nominal demand and uncertainty set. The actual Table 2 compares the results of diﬀerent path shares. The average travel times are calculated over all We also observe that the uniform path shares are worse than the status quo scenario, meaning that current Figure 7 shows the average travel time and waiting time for diﬀerent paths. We observe that the : changes compared to the status quo utilization of the system’s capacity. However, for other path shares, passengers using parallel buses have signiﬁcantly longer travel times than those using other paths. Looking at Figure 7, the average waiting time for the status quo scenario is around 30 minutes, which means most passengers chose to use the parallel bus during the incident, causing severe congestion. However, with the optimization-based path shares, the average waiting time for the parallel bus is less than 5 minutes (around a headway). some passengers’ travel time may be increased compared to the status quo. Figure 8 shows the individual travel time change distribution (optimization-based minus the status quo) for all passengers with non-zero changes. We observe that, though most of the passengers have decreased travel time, some passengers become worse-oﬀ after following the path recommendation. This is a typical drawback of system optimal (ﬁrst-best) assignment (Lawphongpanich and Yin, 2010). Future studies may explore a Pareto-improving (second-best) path recommendation that ensures no individual becomes worse-oﬀ. In reality, when implementing the recommendations, some paths that lead to extremely worse travel time compared to the status quo can be dropped from the solution. The objective of this study is to minimize the system travel time. However, under the optimal path shares, 6.4. Robust models vs. Nominal model travel time of robust models. We observe that, except for ρ performance than the nominal model. This implies that considering the demand uncertainty can further increase the path recommendation strategies. The best value is ρ incident line passengers is reduced by 2.91% compared to the nominal model. Note that the percentage decreases are relatively small because some passengers’ travel times are not changed. If we only look at incident-line passengers with travel time changes, the average travel times are 47.6 min and 37.9 min for the nominal and RO (ρ In this section, we compare the results of RO with diﬀerent values of ρ. Figure 9 shows the average Note that ρ= 2.33 indicates the largest uncertainty set compared to other values, under which the worst-case demand patterns may deviate from the actual demand too much, thus performing worse than the nominal model. To validate this, we plot the worst-case demand for diﬀerent values of ρ is found that the worst-case demands for ρ and ρ performance in Figure 9. 7. Conclusion and discussion disruptions. Passengers with diﬀerent ODs and departure times are recommended with diﬀerent paths such that the system travel time is minimized. To tackle the non-analytical formulation of travel times due to left behind, we propose a simulation-based ﬁrst-order approximation to transform the original problem into linear programming and solve the new problem iteratively with MSA. Uncertainties in demand are modeled with RO techniques to protect the path recommendation strategies against inaccurate estimates. A realworld rail disruption scenario in the CTA system is used as a case study. Results show that even without considering uncertainty, the nominal model can reduce the system travel time by 9.1% (compared to the status quo), and outperforms the benchmark capacity-based path recommendation. The average travel time of passengers in the incident line is reduced more (-20.6% compared to the status quo). After incorporating the demand uncertainty, the robust model can further reduce the system travel time. The best robust model with ρ nominal model. be that demand variations at the incident situation have a limited impact on the optimal path shares. Notice that the demand during an incident is already very high for the system (due to the reduced supply level). The path recommendation patterns at nominal and worst-case demand may not be so diﬀerent as they are both high demand for the system. However, the methodology presented in this study provides a general way = 2.33 overestimate the demands for h = 0, 1. These results are consistent with the travel time In this paper, we propose a path recommendation model to mitigate the congestion during public transit = 0.84 can decrease the average travel time of incident-line passengers by 2.91% compared to the The performance increase by incorporating demand uncertainty is not very signiﬁcant. The reason may to deal with PT demand uncertainty. It can be used for other operations control, optimization, planning, or recommendation tasks. we did not implement these extensions in the case study due to the complexity in updating inputs at the simulation environment. Incorporating real-time information as an adaptive RO would generally increase the model’s performance (Bertsimas et al., 2011). This can be done for future related models with easily adjustable inputs. to be quantiﬁed with a budget factor ρ in many previous RO problems (Bertsimas et al., 2012; Guo et al., 2021). Future studies may develop some data-driven uncertainty quantiﬁcation methods to automate the hyperparameter tuning process. 2) As shown in Figure 8, the system optimal path recommendation may result in worse-oﬀ travel time for some passengers, causing equity and fairness issues. Future studies may consider incorporating Pareto-improving constraints to ensure that all passengers are better-oﬀ if following our recommendation. 3) In this study, we ignore the potential non-compliance problem. That is, passengers may not follow the recommendation and the actual path ﬂows may deviate from the expectation. Future research may develop new modeling techniques for path recommendations to capture behavior uncertainty. 4) Finally, this study presents an OD-based (aggregated) path recommendation regime. Passengers with the same OD and departure time are treated homogeneously. In reality, diﬀerent passengers may have diﬀerent preferences on path choices. And these preferences can aﬀect their compliance with recommendations. Future studies can develop an individualized path recommendation system considering heterogeneous passenger preferences. 8. Acknowledgement for this research. Though we discussed the potential model extension with rolling horizon and incident duration uncertainty, Future research can be explored from the following directions. 1) Current demand uncertainty sets need The authors would like to thank Chicago Transit Authority (CTA) for their support and data availability